import{r as o,u as q,s as g,j as e}from"./index-4fl_mEjj.js";import{a as M,K as z}from"./html5-qrcode-scanner-C9EJ8fvs.js";import{D as k}from"./DeliveryLayout-CXH0Xk9o.js";import{A as U}from"./arrow-left-BJgeFBNw.js";import{S as V}from"./scan-line-DgtaiuF4.js";import{C as A}from"./camera-CAqOsqqg.js";import{R as Q}from"./refresh-cw-CroeC85E.js";import"./createLucideIcon-DGm6Wim6.js";import"./x-B8X7lZOY.js";import"./menu-5lsVQnXG.js";import"./truck-COZlEb6f.js";import"./layout-dashboard-CUFDpKip.js";import"./wallet-DRWcPQQN.js";import"./banknote-uCNahxc1.js";import"./home-Dlzpkrth.js";import"./log-out-CYK8datx.js";function te(){const[p,i]=o.useState(""),[d,X]=o.useState(""),[u,v]=o.useState(!1),[h,j]=o.useState(!1),[w,m]=o.useState(""),[y,f]=o.useState(!1),l=o.useRef(null),N=q();o.useEffect(()=>(u||S(),()=>{b()}),[u]);const S=async()=>{var t;if(m(""),f(!1),window.location.protocol!=="https:"&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"){m("La caméra nécessite une connexion HTTPS sécurisée.");return}if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){m("Votre navigateur ne supporte pas l'accès à la caméra.");return}try{if(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(r=>{r.getTracks().forEach(s=>s.stop())}),l.current)try{await l.current.stop()}catch{}l.current=new M("qr-reader",{verbose:!1}),await l.current.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},L,()=>{}),f(!0)}catch(r){console.error("Camera error:",r);let s="Impossible d'accéder à la caméra.";r.name==="NotAllowedError"||(t=r.message)!=null&&t.includes("Permission")?s="Permission caméra refusée. Veuillez autoriser l'accès à la caméra dans les paramètres de votre navigateur.":r.name==="NotFoundError"?s="Aucune caméra trouvée sur cet appareil.":r.name==="NotReadableError"?s="La caméra est utilisée par une autre application.":r.name==="OverconstrainedError"?s="La caméra arrière n'est pas disponible.":r.name==="SecurityError"&&(s="Accès à la caméra bloqué. Vérifiez que vous utilisez HTTPS."),m(s)}},b=async()=>{if(l.current&&y)try{await l.current.stop(),f(!1)}catch{}},L=async t=>{await b(),C(t)},C=async t=>{j(!0),i("");try{let r=t,s=!1;if(t.includes("http"))try{const a=new URL(t);if(t.includes("/verify/")){const n=a.hash?a.hash.split("/verify/"):a.pathname.split("/verify/");n[1]&&(r=n[1].split("?")[0].split("/")[0])}else if(t.includes("bordereau=")){const n=a.hash?new URLSearchParams(a.hash.split("?")[1]).get("bordereau"):a.searchParams.get("bordereau");n&&(r=n,s=!0)}else if(t.includes("exchange_code=")){const n=a.hash?new URLSearchParams(a.hash.split("?")[1]).get("exchange_code"):a.searchParams.get("exchange_code");n&&(r=n)}}catch{}try{const a=JSON.parse(t);a.exchange_code?r=a.exchange_code:a.bordereau_code&&(r=a.bordereau_code,s=!0)}catch{}r=r.trim().toUpperCase(),r.startsWith("BDX-")&&(s=!0);let x=r;if(s){const{data:a,error:n}=await g.from("merchant_bordereaux").select("exchange_id").eq("bordereau_code",r).maybeSingle();if(n)throw n;if(!a||!a.exchange_id){i("Ce bordereau n'est pas encore associé à un échange. Le client doit d'abord scanner le QR code pour créer l'échange.");return}const{data:R,error:_}=await g.from("exchanges").select("exchange_code").eq("id",a.exchange_id).maybeSingle();if(_)throw _;if(!R){i("Échange non trouvé pour ce bordereau.");return}x=R.exchange_code}const{data:c,error:E}=await g.from("exchanges").select("*").eq("exchange_code",x).maybeSingle();if(E)throw E;if(!c){i("Code d'échange non trouvé. Vérifiez le bordereau.");return}if(!["validated","preparing","in_transit"].includes(c.status)){c.status==="pending"?i("Cet échange n'a pas encore été validé par le commerçant."):c.status==="delivery_verified"||c.status==="completed"?i("Cet échange a déjà été vérifié."):c.status==="rejected"||c.status==="delivery_rejected"?i("Cet échange a été refusé."):i("Cet échange n'est pas dans un état permettant la vérification.");return}N(`/delivery/verify/${x}`)}catch(r){console.error("Error validating exchange code:",r),i("Erreur lors de la validation du code. Veuillez réessayer.")}finally{j(!1)}},P=t=>{t.preventDefault(),d.trim()&&C(d.trim())};return e.jsx(k,{children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>N("/delivery/dashboard"),className:"flex items-center gap-2 text-slate-600 hover:text-slate-900 mb-6",children:[e.jsx(U,{className:"w-5 h-5"}),"Retour au dashboard"]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-full mb-4",children:e.jsx(V,{className:"w-8 h-8 text-amber-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:"Scanner le Bordereau"}),e.jsx("p",{className:"text-slate-600",children:"Scannez le QR code du bordereau pour accéder aux détails de l'échange"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[p&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:p}),h&&e.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-amber-600"}),"Vérification en cours..."]}),u?e.jsxs("form",{onSubmit:P,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Code d'échange"}),e.jsx("input",{type:"text",value:d,onChange:t=>X(t.target.value),placeholder:"EXC-XXXXXXXXXX-XXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 font-mono"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:h||!d.trim(),className:"w-full py-3 bg-amber-600 hover:bg-amber-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:h?"Vérification...":"Rechercher l'échange"}),e.jsx("button",{type:"button",onClick:()=>v(!1),className:"w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:"Retour au scanner"})]})]}):e.jsxs("div",{children:[w?e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(A,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Erreur caméra"})]}),e.jsx("p",{className:"text-sm",children:w})]}),e.jsxs("button",{onClick:S,className:"w-full flex items-center justify-center gap-2 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-colors mb-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Réessayer"]})]}):e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{id:"qr-reader",className:"rounded-lg overflow-hidden"}),y&&e.jsxs("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Caméra active - Scannez le QR code"]})]}),e.jsxs("button",{onClick:()=>{b(),v(!0)},className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(z,{className:"w-5 h-5"}),"Entrer le code manuellement"]})]}),e.jsx("div",{className:"mt-6 p-4 bg-amber-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-amber-800",children:"Scannez le QR code imprimé sur le bordereau d'échange pour accéder à l'historique du client et vérifier le produit."})})]})]})})}export{te as default};
