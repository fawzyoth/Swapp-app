import{s as E,j as e}from"./index-zDZ3Lj_p.js";import{r as t,u as X}from"./react-vendor-CTUriZ5h.js";import{a as k}from"./qr-scanner-QRjSEYwL.js";import{D as z}from"./DeliveryLayout-DhTvOimz.js";import{A as _}from"./arrow-left-CxjwE-xR.js";import{S as L}from"./scan-line-Dhzz-_Ia.js";import{c as q}from"./createLucideIcon-CMjKDoEE.js";import{R as M}from"./refresh-cw-EGIEbGnh.js";import{K as V}from"./key-round-jTceDe-V.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./menu-DP2azNEK.js";import"./truck-CgEV9F53.js";import"./layout-dashboard-CqNl1jWq.js";import"./banknote-JI0QWWz-.js";import"./home-9mW_oZwz.js";import"./log-out-BX30H4-p.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=q("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);function re(){const[h,s]=t.useState(""),[i,C]=t.useState(""),[o,x]=t.useState(!1),[d,f]=t.useState(!1),[b,p]=t.useState(""),[g,m]=t.useState(!1),n=t.useRef(null),v=X();t.useEffect(()=>(o||j(),()=>{u()}),[o]);const j=async()=>{var r;p(""),m(!1);try{if(n.current)try{await n.current.stop()}catch{}n.current=new k("qr-reader",{verbose:!1}),await n.current.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},S,()=>{}),m(!0)}catch(a){console.error("Camera error:",a),p((r=a.message)!=null&&r.includes("Permission")?"Permission caméra refusée. Veuillez autoriser l'accès à la caméra.":"Impossible d'accéder à la caméra. Utilisez l'entrée manuelle.")}},u=async()=>{if(n.current&&g)try{await n.current.stop(),m(!1)}catch{}},S=async r=>{await u(),y(r)},y=async r=>{f(!0),s("");try{let a=r;if(r.includes("/verify/")||r.includes("exchange_code="))try{const c=new URL(r),w=c.searchParams.get("exchange_code")||c.pathname.split("/verify/")[1];w&&(a=w)}catch{}try{const c=JSON.parse(r);c.exchange_code&&(a=c.exchange_code)}catch{}a=a.trim().toUpperCase();const{data:l,error:N}=await E.from("exchanges").select("*").eq("exchange_code",a).maybeSingle();if(N)throw N;if(!l){s("Code d'échange non trouvé. Vérifiez le bordereau.");return}if(!["validated","preparing","in_transit"].includes(l.status)){l.status==="pending"?s("Cet échange n'a pas encore été validé par le commerçant."):l.status==="delivery_verified"||l.status==="completed"?s("Cet échange a déjà été vérifié."):l.status==="rejected"||l.status==="delivery_rejected"?s("Cet échange a été refusé."):s("Cet échange n'est pas dans un état permettant la vérification.");return}v(`/delivery/verify/${a}`)}catch(a){console.error("Error validating exchange code:",a),s("Erreur lors de la validation du code. Veuillez réessayer.")}finally{f(!1)}},R=r=>{r.preventDefault(),i.trim()&&y(i.trim())};return e.jsx(z,{children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>v("/delivery/dashboard"),className:"flex items-center gap-2 text-slate-600 hover:text-slate-900 mb-6",children:[e.jsx(_,{className:"w-5 h-5"}),"Retour au dashboard"]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-full mb-4",children:e.jsx(L,{className:"w-8 h-8 text-amber-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:"Scanner le Bordereau"}),e.jsx("p",{className:"text-slate-600",children:"Scannez le QR code du bordereau pour accéder aux détails de l'échange"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[h&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:h}),d&&e.jsxs("div",{className:"mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-amber-600"}),"Vérification en cours..."]}),o?e.jsxs("form",{onSubmit:R,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Code d'échange"}),e.jsx("input",{type:"text",value:i,onChange:r=>C(r.target.value),placeholder:"EXC-XXXXXXXXXX-XXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 font-mono"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:d||!i.trim(),className:"w-full py-3 bg-amber-600 hover:bg-amber-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:d?"Vérification...":"Rechercher l'échange"}),e.jsx("button",{type:"button",onClick:()=>x(!1),className:"w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:"Retour au scanner"})]})]}):e.jsxs("div",{children:[b?e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(U,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Erreur caméra"})]}),e.jsx("p",{className:"text-sm",children:b})]}),e.jsxs("button",{onClick:j,className:"w-full flex items-center justify-center gap-2 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-colors mb-2",children:[e.jsx(M,{className:"w-5 h-5"}),"Réessayer"]})]}):e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{id:"qr-reader",className:"rounded-lg overflow-hidden"}),g&&e.jsxs("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Caméra active - Scannez le QR code"]})]}),e.jsxs("button",{onClick:()=>{u(),x(!0)},className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(V,{className:"w-5 h-5"}),"Entrer le code manuellement"]})]}),e.jsx("div",{className:"mt-6 p-4 bg-amber-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-amber-800",children:"Scannez le QR code imprimé sur le bordereau d'échange pour accéder à l'historique du client et vérifier le produit."})})]})]})})}export{re as default};
