import{u as U,r as d,s as h,j as e,L as $}from"./index-CQ_LRKqG.js";import{M as v}from"./MerchantLayout-BY2gk5uq.js";import{U as b}from"./users-DVzjBHSD.js";import{T as F}from"./trending-up-SKtT3bkQ.js";import{A as N}from"./award-BqTcpTGD.js";import{P as w}from"./package-euHH1Ynp.js";import{S as q}from"./search-D4jlkjVa.js";import{F as I}from"./filter-CPDK3z2a.js";import{P as B}from"./phone-BloR-R3s.js";import{M as z}from"./mail-BNZCtQbq.js";import{C as G}from"./clock-CzMshNXu.js";import{C as H}from"./chevron-right-4k3MFnrn.js";import"./x-BXOCxbM_.js";import"./createLucideIcon-_6ROX8yg.js";import"./menu-BxfI3nIZ.js";import"./store-Cz-oRZt_.js";import"./layout-dashboard-BZxJ5DpE.js";import"./truck-Cnf3_ycc.js";import"./banknote-B-tG0m_s.js";import"./message-square-DaG2BKN2.js";import"./star-z966A4YF.js";import"./video-BzEE77Gk.js";import"./log-out-DgqNs_DR.js";function pe(){const y=U(),[l,E]=d.useState([]),[k,S]=d.useState(!0),[o,C]=d.useState(""),[g,A]=d.useState("exchanges"),[p,L]=d.useState("all");d.useEffect(()=>{_(),R()},[]);const _=async()=>{const{data:{session:s}}=await h.auth.getSession();s||y("/merchant/login")},R=async()=>{try{const{data:{session:s}}=await h.auth.getSession();if(!s)return;const{data:a}=await h.from("merchants").select("id").eq("email",s.user.email).maybeSingle();if(!a)return;const{data:x}=await h.from("exchanges").select("id, client_name, client_phone, status, created_at").eq("merchant_id",a.id).order("created_at",{ascending:!1});if(x){const m=new Map;x.forEach(t=>{const n=t.client_phone;m.has(n)||m.set(n,{name:t.client_name,phone:t.client_phone,email:`${t.client_name.toLowerCase().replace(/\s/g,"")}@example.com`,exchanges:[],firstExchange:t.created_at,lastExchange:t.created_at});const c=m.get(n);c.exchanges.push(t),new Date(t.created_at)<new Date(c.firstExchange)&&(c.firstExchange=t.created_at),new Date(t.created_at)>new Date(c.lastExchange)&&(c.lastExchange=t.created_at)});const M=Array.from(m.values()).map(t=>{const n=t.exchanges.filter(i=>i.status==="validated"||i.status==="completed").length,c=t.exchanges.filter(i=>i.status==="pending").length,D=t.exchanges.filter(i=>i.status==="rejected").length,u=t.exchanges.length,T=u>0?Math.round(n/u*100):0,j=Math.floor((Date.now()-new Date(t.lastExchange).getTime())/(1e3*60*60*24)),P=j<=30;return{...t,totalExchanges:u,acceptanceRate:T,validated:n,pending:c,rejected:D,daysSinceLastExchange:j,isActive:P}});E(M)}}catch(s){console.error("Error fetching clients:",s)}finally{S(!1)}},f=l.filter(s=>{const a=s.name.toLowerCase().includes(o.toLowerCase())||s.phone.includes(o)||s.email.toLowerCase().includes(o.toLowerCase()),x=p==="all"?!0:p==="active"?s.isActive:!s.isActive;return a&&x}).sort((s,a)=>{switch(g){case"exchanges":return a.totalExchanges-s.totalExchanges;case"rate":return a.acceptanceRate-s.acceptanceRate;case"recent":return new Date(a.lastExchange).getTime()-new Date(s.lastExchange).getTime();default:return 0}}),r={total:l.length,active:l.filter(s=>s.isActive).length,avgRate:l.length>0?Math.round(l.reduce((s,a)=>s+a.acceptanceRate,0)/l.length):0,recurring:l.filter(s=>s.totalExchanges>1).length,totalExchanges:l.reduce((s,a)=>s+a.totalExchanges,0)};return k?e.jsx(v,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600"})})}):e.jsx(v,{children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:"Gestion des Clients"}),e.jsx("p",{className:"text-slate-600",children:"Vue d'ensemble de vos clients et de leur activité"})]}),e.jsxs("div",{className:"grid md:grid-cols-4 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-5",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-sky-100 rounded-lg",children:e.jsx(b,{className:"w-5 h-5 text-sky-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:r.total}),e.jsx("div",{className:"text-xs text-slate-600",children:"Clients uniques"})]})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-5",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-emerald-100 rounded-lg",children:e.jsx(F,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:r.active}),e.jsx("div",{className:"text-xs text-slate-600",children:"Clients actifs"})]})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-5",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(N,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:[r.avgRate,"%"]}),e.jsx("div",{className:"text-xs text-slate-600",children:"Taux d'acceptation"})]})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-5",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:e.jsx(w,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:r.totalExchanges}),e.jsx("div",{className:"text-xs text-slate-600",children:"Échanges totaux"})]})]})})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(q,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par nom, téléphone ou email...",value:o,onChange:s=>C(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Statut:"})]}),e.jsxs("select",{value:p,onChange:s=>L(s.target.value),className:"px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500",children:[e.jsxs("option",{value:"all",children:["Tous (",r.total,")"]}),e.jsxs("option",{value:"active",children:["Actifs (",r.active,")"]}),e.jsxs("option",{value:"inactive",children:["Inactifs (",r.total-r.active,")"]})]}),e.jsxs("select",{value:g,onChange:s=>A(s.target.value),className:"px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500",children:[e.jsx("option",{value:"exchanges",children:"Plus d'échanges"}),e.jsx("option",{value:"rate",children:"Meilleur taux"}),e.jsx("option",{value:"recent",children:"Plus récents"})]})]})]})}),f.length===0?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx(b,{className:"w-16 h-16 text-slate-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Aucun client trouvé"}),e.jsx("p",{className:"text-slate-600",children:o?"Essayez de modifier votre recherche":"Les clients apparaîtront ici après leur premier échange"})]}):e.jsx("div",{className:"space-y-3",children:f.map((s,a)=>e.jsx($,{to:`/merchant/client/${encodeURIComponent(s.phone)}`,className:"block bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-sky-200 transition-all p-5 group",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-sky-100 to-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-lg font-bold text-sky-700",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-semibold text-slate-900 text-lg truncate",children:s.name}),s.isActive&&e.jsx("span",{className:"px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full",children:"Actif"}),s.totalExchanges>5&&e.jsx(N,{className:"w-4 h-4 text-amber-500"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:s.phone})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"truncate",children:s.email})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 pl-15",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Échanges"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"w-4 h-4 text-sky-600"}),e.jsx("span",{className:"font-semibold text-slate-900",children:s.totalExchanges})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Taux acceptation"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 bg-slate-200 rounded-full h-1.5 max-w-[60px]",children:e.jsx("div",{className:`h-1.5 rounded-full ${s.acceptanceRate>=80?"bg-emerald-500":s.acceptanceRate>=50?"bg-amber-500":"bg-red-500"}`,style:{width:`${s.acceptanceRate}%`}})}),e.jsxs("span",{className:"text-sm font-semibold text-slate-900",children:[s.acceptanceRate,"%"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Statuts"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[s.pending>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-100 text-amber-700 rounded",children:[s.pending," en attente"]}),s.validated>0&&e.jsxs("span",{className:"px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded",children:[s.validated," validés"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Dernière activité"}),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-slate-700",children:[e.jsx(G,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:s.daysSinceLastExchange===0?"Aujourd'hui":s.daysSinceLastExchange===1?"Hier":`Il y a ${s.daysSinceLastExchange}j`})]})]})]})]}),e.jsx(H,{className:"w-5 h-5 text-slate-400 group-hover:text-sky-600 transition-colors flex-shrink-0"})]})},a))})]})})}export{pe as default};
