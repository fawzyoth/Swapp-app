import{s as o,j as e,d as G,e as I}from"./index-DZYJF6_c.js";import{r as n}from"./react-vendor-CTUriZ5h.js";import{A as F}from"./AdminLayout-C0V2Ko4g.js";import{P as U}from"./plus-BbVUCmx5.js";import{C as H}from"./clock-Dhxn45-3.js";import{W as T}from"./wallet-CVOcG8S4.js";import{A as J}from"./alert-circle-_Iqic_ih.js";import{C as K}from"./check-circle-CyNeZd0p.js";import{S as Q}from"./search-CPbK6Y1N.js";import{C as V}from"./chevron-right-DAoz1ith.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./shield-BNgLrtrc.js";import"./layout-dashboard-CqNl1jWq.js";import"./users-4zMWxYqH.js";import"./truck-CgEV9F53.js";import"./banknote-JI0QWWz-.js";import"./store-B-5iV_wL.js";import"./file-text-B3Ewreww.js";import"./home-9mW_oZwz.js";function je(){const[m,P]=n.useState([]),[X,k]=n.useState([]),[x,A]=n.useState([]),[L,E]=n.useState(!0),[g,O]=n.useState(""),[f,R]=n.useState("all"),[q,p]=n.useState(!1),[l,v]=n.useState(""),[i,b]=n.useState(""),[y,w]=n.useState(""),[D,_]=n.useState(!1);n.useEffect(()=>{j()},[]);const j=async()=>{try{const{data:s}=await o.from("delivery_deposits").select(`
          *,
          delivery_person:delivery_persons(id, name, phone)
        `).order("created_at",{ascending:!1}),{data:t}=await o.from("delivery_persons").select("*").order("name"),{data:a}=await o.from("delivery_verifications").select(`
          *,
          exchange:exchanges(
            id,
            exchange_code,
            merchant_id,
            merchants(name)
          ),
          delivery_person:delivery_persons(id, name)
        `).eq("payment_collected",!0).is("deposit_id",null).order("created_at",{ascending:!1});P(s||[]),k(t||[]),A(a||[])}finally{E(!1)}},B=async()=>{if(!(!l||!i)){_(!0);try{const s=x.filter(c=>c.delivery_person_id===l),t=s.reduce((c,N)=>c+(N.amount_collected||0),0),a=parseFloat(i),d=t-a,{count:h}=await o.from("delivery_deposits").select("*",{count:"exact",head:!0}),$=G((h||0)+1),{data:S,error:z}=await o.from("delivery_deposits").insert({deposit_number:$,delivery_person_id:l,deposit_date:new Date().toISOString(),total_collected:t,total_exchanges:s.length,amount_deposited:a,discrepancy:d,status:d===0?"confirmed":"pending",received_by:"admin",received_at:new Date().toISOString(),notes:y||null}).select().single();if(!z&&S){const c=s.map(N=>N.id);await o.from("delivery_verifications").update({deposit_id:S.id}).in("id",c),p(!1),v(""),b(""),w(""),j()}}finally{_(!1)}}},M=s=>{const t={pending:"bg-amber-100 text-amber-700",confirmed:"bg-emerald-100 text-emerald-700",disputed:"bg-red-100 text-red-700"};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t[s]||"bg-slate-100 text-slate-700"}`,children:I[s]||s})},W=async s=>{await o.from("delivery_deposits").update({status:"confirmed",received_at:new Date().toISOString()}).eq("id",s),j()},u={totalPending:x.reduce((s,t)=>s+(t.amount_collected||0),0),pendingCount:x.length,todayDeposits:m.filter(s=>new Date(s.deposit_date).toDateString()===new Date().toDateString()).reduce((s,t)=>s+t.amount_deposited,0),pendingDeposits:m.filter(s=>s.status==="pending").length},C=m.filter(s=>{var d,h;const t=s.deposit_number.toLowerCase().includes(g.toLowerCase())||((h=(d=s.delivery_person)==null?void 0:d.name)==null?void 0:h.toLowerCase().includes(g.toLowerCase())),a=f==="all"||s.status===f;return t&&a}),r=x.reduce((s,t)=>{const a=t.delivery_person_id;return s[a]||(s[a]={deliveryPerson:t.delivery_person,collections:[],total:0}),s[a].collections.push(t),s[a].total+=t.amount_collected||0,s},{});return L?e.jsx(F,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})})}):e.jsx(F,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:"Collectes Livreurs"}),e.jsx("p",{className:"text-slate-600",children:"Gestion des dépôts espèces des livreurs"})]}),e.jsxs("button",{onClick:()=>p(!0),className:"inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx(U,{className:"w-4 h-4"}),"Nouveau Dépôt"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(H,{className:"w-5 h-5 text-amber-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"À Collecter"})]}),e.jsxs("p",{className:"text-2xl font-bold text-slate-900",children:[u.totalPending.toFixed(2)," TND"]}),e.jsxs("p",{className:"text-xs text-slate-500",children:[u.pendingCount," échanges"]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(T,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Dépôts Aujourd'hui"})]}),e.jsxs("p",{className:"text-2xl font-bold text-slate-900",children:[u.todayDeposits.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(J,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Dépôts en Attente"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:u.pendingDeposits})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(K,{className:"w-5 h-5 text-sky-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Total Dépôts"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:m.length})]})]}),q&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900 mb-4",children:"Nouveau Dépôt Espèces"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Livreur"}),e.jsxs("select",{value:l,onChange:s=>v(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"",children:"Sélectionner un livreur"}),Object.keys(r).map(s=>{var t;return e.jsxs("option",{value:s,children:[(t=r[s].deliveryPerson)==null?void 0:t.name," - ",r[s].total.toFixed(2)," TND (",r[s].collections.length," échanges)"]},s)})]})]}),l&&r[l]&&e.jsxs("div",{className:"bg-slate-50 rounded-lg p-4",children:[e.jsxs("p",{className:"text-sm text-slate-600 mb-2",children:["Montant à collecter: ",e.jsxs("span",{className:"font-bold text-slate-900",children:[r[l].total.toFixed(2)," TND"]})]}),e.jsxs("p",{className:"text-xs text-slate-500",children:[r[l].collections.length," échanges en attente"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Montant Déposé (TND)"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:i,onChange:s=>b(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500",placeholder:"0.00"})]}),l&&i&&r[l]&&e.jsx("div",{className:`rounded-lg p-3 ${parseFloat(i)===r[l].total?"bg-emerald-50 text-emerald-700":"bg-amber-50 text-amber-700"}`,children:parseFloat(i)===r[l].total?e.jsx("p",{className:"text-sm font-medium",children:"✓ Montant exact"}):e.jsxs("p",{className:"text-sm font-medium",children:["Écart: ",(r[l].total-parseFloat(i)).toFixed(2)," TND"]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Notes (optionnel)"}),e.jsx("textarea",{value:y,onChange:s=>w(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500",rows:2,placeholder:"Remarques..."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>p(!1),className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50",children:"Annuler"}),e.jsx("button",{onClick:B,disabled:!l||!i||D,className:"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:D?"Enregistrement...":"Enregistrer Dépôt"})]})]})}),Object.keys(r).length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 mb-6",children:[e.jsx("div",{className:"p-4 border-b border-slate-200",children:e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Collectes en Attente par Livreur"})}),e.jsx("div",{className:"divide-y divide-slate-200",children:Object.entries(r).map(([s,t])=>{var a;return e.jsx("div",{className:"p-4 hover:bg-slate-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:(a=t.deliveryPerson)==null?void 0:a.name}),e.jsxs("p",{className:"text-sm text-slate-500",children:[t.collections.length," échanges"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-lg font-bold text-amber-600",children:[t.total.toFixed(2)," TND"]}),e.jsx("button",{onClick:()=>{v(s),b(t.total.toFixed(2)),p(!0)},className:"text-sm text-purple-600 hover:text-purple-700",children:"Collecter →"})]})]})},s)})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200",children:[e.jsx("div",{className:"p-4 border-b border-slate-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par numéro ou livreur...",value:g,onChange:s=>O(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"})]}),e.jsxs("select",{value:f,onChange:s=>R(s.target.value),className:"px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500",children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"pending",children:"En attente"}),e.jsx("option",{value:"confirmed",children:"Confirmé"}),e.jsx("option",{value:"disputed",children:"Contesté"})]})]})}),C.length>0?e.jsx("div",{className:"divide-y divide-slate-200",children:C.map(s=>{var t;return e.jsxs("div",{className:"p-4 hover:bg-slate-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center",children:e.jsx(T,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:s.deposit_number}),e.jsxs("p",{className:"text-sm text-slate-500",children:[(t=s.delivery_person)==null?void 0:t.name," • ",s.total_exchanges," échanges"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-slate-900",children:[s.amount_deposited.toFixed(2)," TND"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[M(s.status),s.discrepancy!==0&&e.jsxs("span",{className:"text-xs text-red-600",children:["Écart: ",s.discrepancy.toFixed(2)," TND"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[s.status==="pending"&&e.jsx("button",{onClick:()=>W(s.id),className:"px-3 py-1 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700",children:"Confirmer"}),e.jsx(V,{className:"w-5 h-5 text-slate-400"})]})]}),e.jsx("div",{className:"mt-2 text-xs text-slate-500",children:new Date(s.deposit_date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})})]},s.id)})}):e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Aucun dépôt trouvé"})]})]})})}export{je as default};
