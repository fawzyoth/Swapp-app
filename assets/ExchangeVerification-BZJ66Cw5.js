import{s as c,j as e,S as w}from"./index-CYPRHEJa.js";import{h as K,u as O,r as a}from"./react-vendor-CTUriZ5h.js";import{a as Q}from"./qr-libs-Cb5OB8oe.js";import{D as E}from"./DeliveryLayout-CQjYWEoT.js";import{I as W,c as P}from"./smsService-qtIlF6gc.js";import{A as Z}from"./arrow-left-CxjwE-xR.js";import{U as G}from"./user-DEx4Ce9L.js";import{P as R}from"./phone-BNQXnIac.js";import{P as T}from"./package-ChDCFdB3.js";import{M as z}from"./map-pin-DUtVdt2Q.js";import{H as J}from"./home-9mW_oZwz.js";import{V as Y}from"./video-Cwp6uQ4V.js";import{C as ee}from"./clock-Dhxn45-3.js";import{C as y}from"./check-circle-CyNeZd0p.js";import{X as se}from"./x-circle-D3f66Y07.js";import{T as te}from"./trending-up-9gPHMyOx.js";import{S as ae}from"./scan-line-Dhzz-_Ia.js";import{K as re}from"./key-round-jTceDe-V.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./truck-CgEV9F53.js";import"./layout-dashboard-CqNl1jWq.js";import"./log-out-BX30H4-p.js";function Ae(){const{code:x}=K(),l=O(),[t,h]=a.useState(null),[i,_]=a.useState([]),[S,u]=a.useState(!0),[o,b]=a.useState(!1),[j,m]=a.useState(!1),[g,C]=a.useState(!1),[n,k]=a.useState(null),[d,I]=a.useState(""),[f,D]=a.useState(""),[A,L]=a.useState(""),[q,X]=a.useState(!0),[N,v]=a.useState(!1);a.useEffect(()=>{x&&$()},[x]);const $=async()=>{try{const{data:s,error:p}=await c.from("exchanges").select("*").eq("exchange_code",x).maybeSingle();if(p)throw p;if(s){if(h(s),s.merchant_id){const{data:M}=await c.from("merchants").select("*").eq("id",s.merchant_id).maybeSingle();M&&k(M)}const{data:F}=await c.from("exchanges").select("*").eq("client_phone",s.client_phone).neq("id",s.id).order("created_at",{ascending:!1}).limit(5);_(F||[])}}catch(s){console.error("Error fetching exchange:",s)}finally{u(!1)}},V=()=>{m(!0)},U=async()=>{if(!d.trim()){alert("Veuillez fournir une raison pour le refus");return}v(!0);try{const{data:{user:s}}=await c.auth.getUser();if(!s)throw new Error("Non authentifié");await c.from("exchanges").update({status:"delivery_rejected",updated_at:new Date().toISOString()}).eq("id",t.id),await c.from("delivery_verifications").insert({exchange_id:t.id,delivery_person_id:s.id,status:"rejected",rejection_reason:d}),await c.from("status_history").insert({exchange_id:t.id,status:"delivery_rejected"}),await P(t.client_phone,t.client_name,t.exchange_code,"delivery_rejected",w.delivery_rejected),b(!1),l("/delivery/dashboard")}catch(s){console.error("Error rejecting exchange:",s),alert("Erreur lors du refus de l'échange")}finally{v(!1)}},H=async s=>{D(s)},B=async()=>{if(!f.trim()){alert("Veuillez scanner ou entrer l'ID du sac");return}v(!0);try{const{data:{user:s}}=await c.auth.getUser();if(!s)throw new Error("Non authentifié");await c.from("exchanges").update({status:"delivery_verified",bag_id:f,updated_at:new Date().toISOString()}).eq("id",t.id),await c.from("delivery_verifications").insert({exchange_id:t.id,delivery_person_id:s.id,status:"accepted",bag_id:f}),await c.from("status_history").insert({exchange_id:t.id,status:"delivery_verified"}),await P(t.client_phone,t.client_name,t.exchange_code,"delivery_verified",w.delivery_verified),L(f),m(!1),C(!0)}catch(s){console.error("Error accepting exchange:",s),alert("Erreur lors de l'acceptation de l'échange")}finally{v(!1)}};if(S)return e.jsx(E,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600"})})});if(!t)return e.jsx(E,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Échange non trouvé"}),e.jsxs("p",{className:"text-slate-600 mb-4",children:['Le code "',x,`" n'existe pas.`]}),e.jsx("button",{onClick:()=>l("/delivery/scan"),className:"px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700",children:"Retour au scanner"})]})})});const r={total:i.length,validated:i.filter(s=>s.status==="validated"||s.status==="completed"||s.status==="delivery_verified").length,rejected:i.filter(s=>s.status==="rejected"||s.status==="delivery_rejected").length};return e.jsx(E,{children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("button",{onClick:()=>l("/delivery/scan"),className:"flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors mb-6",children:[e.jsx(Z,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Retour au scanner"})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-1",children:t.exchange_code}),e.jsxs("p",{className:"text-slate-600",children:["Créé le"," ",new Date(t.created_at).toLocaleDateString("fr-FR")]})]}),e.jsx("span",{className:`px-4 py-2 rounded-full text-sm font-medium ${t.status==="validated"?"bg-emerald-100 text-emerald-800 border border-emerald-200":t.status==="in_transit"?"bg-blue-100 text-blue-800 border border-blue-200":"bg-amber-100 text-amber-800 border border-amber-200"}`,children:w[t.status]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-slate-50 rounded-xl p-5 border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(G,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-slate-900",children:"Client"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Nom:"}),e.jsx("p",{className:"font-medium text-slate-900",children:t.client_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Téléphone:"}),e.jsx("p",{className:"font-medium text-slate-900",children:e.jsxs("a",{href:`tel:${t.client_phone}`,className:"text-amber-600 hover:text-amber-700 flex items-center gap-1",children:[e.jsx(R,{className:"w-4 h-4"}),t.client_phone]})})]})]})]}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-5 border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(T,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-slate-900",children:"Produit"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Nom:"}),e.jsx("p",{className:"font-medium text-slate-900",children:t.product_name||"Non spécifié"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Raison d'échange:"}),e.jsx("p",{className:"font-medium text-slate-900",children:t.reason})]})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border border-amber-200 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(z,{className:"w-5 h-5 text-amber-700"}),e.jsx("h3",{className:"font-semibold text-slate-900",children:"Adresse de livraison"})]}),e.jsx("div",{className:"space-y-2 text-sm",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:t.client_address||"Non fournie"}),e.jsx("p",{className:"text-slate-700",children:t.client_city&&t.client_postal_code?`${t.client_city} ${t.client_postal_code}, ${t.client_country||"Tunisia"}`:"Informations incomplètes"})]})]})})]}),t.video&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-slate-900",children:"Vidéo de référence"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(t.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})})]})]}),e.jsx("div",{className:"bg-black rounded-lg overflow-hidden",children:e.jsx("video",{src:t.video,controls:!0,className:"w-full max-h-96",poster:""})}),e.jsxs("p",{className:"text-sm text-amber-700 mt-2 bg-amber-50 p-3 rounded-lg border border-amber-200",children:[e.jsx("strong",{children:"Important:"})," Comparez le produit présenté par le client avec cette vidéo de référence avant d'accepter l'échange."]})]}),t.photos&&t.photos.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-semibold text-slate-900 mb-4",children:"Photos du produit"}),e.jsx("div",{className:"grid grid-cols-3 gap-4",children:t.photos.map((s,p)=>e.jsx("img",{src:s,alt:`Photo ${p+1}`,className:"w-full h-40 object-cover rounded-lg border border-slate-200 cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>window.open(s,"_blank")},p))})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t border-slate-200",children:[e.jsxs("button",{onClick:V,className:"flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2",children:[e.jsx(y,{className:"w-5 h-5"}),"Accepter l'échange"]}),e.jsxs("button",{onClick:()=>b(!0),className:"flex-1 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2",children:[e.jsx(se,{className:"w-5 h-5"}),"Refuser l'échange"]})]})]})}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(te,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-slate-900",children:"Historique du client"})]}),i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(W,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Premier échange de ce client"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 border border-slate-200",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:r.total}),e.jsx("div",{className:"text-xs text-slate-600",children:"Échanges"})]}),e.jsxs("div",{className:"bg-emerald-50 rounded-lg p-3 border border-emerald-200",children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-700",children:r.validated}),e.jsx("div",{className:"text-xs text-emerald-700",children:"Validés"})]}),e.jsxs("div",{className:"bg-red-50 rounded-lg p-3 border border-red-200",children:[e.jsx("div",{className:"text-2xl font-bold text-red-700",children:r.rejected}),e.jsx("div",{className:"text-xs text-red-700",children:"Refusés"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-700 mb-2",children:"Derniers échanges"}),i.slice(0,3).map(s=>e.jsxs("div",{className:"bg-slate-50 rounded-lg p-3 border border-slate-200 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-mono text-xs text-slate-600",children:s.exchange_code}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${s.status==="validated"||s.status==="completed"||s.status==="delivery_verified"?"bg-emerald-100 text-emerald-700":s.status==="rejected"||s.status==="delivery_rejected"?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}`,children:w[s.status]})]}),e.jsx("p",{className:"text-xs text-slate-600 truncate",children:s.reason}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:new Date(s.created_at).toLocaleDateString("fr-FR")})]},s.id))]}),r.total>0&&e.jsx("div",{className:`rounded-lg p-3 border ${r.validated/r.total>=.7?"bg-emerald-50 border-emerald-200":r.validated/r.total>=.4?"bg-amber-50 border-amber-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:`w-4 h-4 ${r.validated/r.total>=.7?"text-emerald-600":r.validated/r.total>=.4?"text-amber-600":"text-red-600"}`}),e.jsxs("span",{className:"text-sm font-medium",children:["Taux de validation:"," ",Math.round(r.validated/r.total*100),"%"]})]})})]})]})})]}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-2xl font-bold text-slate-900 mb-4",children:"Refuser l'échange"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Veuillez expliquer pourquoi vous refusez cet échange"}),e.jsx("textarea",{value:d,onChange:s=>I(s.target.value),placeholder:"Ex: Le produit ne correspond pas à la vidéo de référence...",rows:4,className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>b(!1),disabled:N,className:"flex-1 px-6 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:U,disabled:N,className:"flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:N?"Traitement...":"Confirmer le refus"})]})]})})}),j&&e.jsx(le,{onScan:H,bagId:f,setBagId:D,useBarcodeScanner:q,setUseBarcodeScanner:X,onConfirm:B,onCancel:()=>m(!1),processing:N}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(y,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Échange Accepté"}),e.jsx("p",{className:"text-slate-600",children:"Le retour a été assigné au sac de collecte"})]}),e.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(T,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"font-semibold text-emerald-900",children:"Sac assigné"})]}),e.jsx("p",{className:"font-mono text-lg text-emerald-800",children:A})]}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(z,{className:"w-5 h-5 text-amber-600"}),e.jsx("span",{className:"font-semibold text-amber-900",children:"Adresse de retour E-Commerçant"})]}),n?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-slate-900",children:n.name}),e.jsx("p",{className:"text-slate-700",children:n.address||"123 Rue du Commerce"}),e.jsxs("p",{className:"text-slate-700",children:[n.city||"Tunis"," ",n.postal_code||"1000"]}),e.jsxs("p",{className:"text-slate-600 flex items-center gap-1 mt-2",children:[e.jsx(R,{className:"w-4 h-4"}),n.phone||"+216 XX XXX XXX"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-slate-900",children:"SWAPP E-Commerce"}),e.jsx("p",{className:"text-slate-700",children:"Zone Industrielle, Rue de l'Innovation"}),e.jsx("p",{className:"text-slate-700",children:"Tunis 1000, Tunisia"}),e.jsxs("p",{className:"text-slate-600 flex items-center gap-1 mt-2",children:[e.jsx(R,{className:"w-4 h-4"}),"+216 71 234 567"]})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Instructions:"})," Déposez le sac"," ",e.jsx("span",{className:"font-mono",children:A})," à l'adresse indiquée ci-dessus pour retourner l'article au e-commerçant."]})}),e.jsx("button",{onClick:()=>l("/delivery/dashboard"),className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",children:"Terminer"})]})})})]})})}function le({onScan:x,bagId:l,setBagId:t,useBarcodeScanner:h,setUseBarcodeScanner:i,onConfirm:_,onCancel:S,processing:u}){const o=a.useRef(null),[b,j]=a.useState(!1),[m,g]=a.useState(""),C=async()=>{g("");try{if(o.current)try{await o.current.stop()}catch{}o.current=new Q("bag-scanner",{verbose:!1}),await o.current.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:150},aspectRatio:1},d=>{t(d),n()},()=>{}),j(!0)}catch(d){console.error("Camera error:",d),g("Impossible d'accéder à la caméra. Utilisez l'entrée manuelle.")}},n=async()=>{if(o.current)try{await o.current.stop(),j(!1)}catch{}};a.useEffect(()=>(h&&!l&&C(),()=>{n()}),[h,l]);const k=async()=>{await n(),S()};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 bg-emerald-100 rounded-lg",children:e.jsx(ae,{className:"w-6 h-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold text-slate-900",children:"Scanner le sac"}),e.jsx("p",{className:"text-slate-600 text-sm",children:"Scannez le code-barres du sac pour l'assigner"})]})]}),l?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"font-medium text-emerald-900",children:"Sac scanné"})]}),e.jsx("p",{className:"font-mono text-lg text-emerald-800",children:l})]}),e.jsx("button",{onClick:()=>{t(""),i(!0)},className:"mt-2 text-sm text-amber-600 hover:text-amber-700",children:"Scanner un autre sac"})]}):h?e.jsxs("div",{className:"mb-6",children:[m?e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4",children:m}):null,e.jsxs("div",{className:"relative",children:[e.jsx("div",{id:"bag-scanner",className:"rounded-lg overflow-hidden mb-4"}),b&&e.jsxs("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Caméra active"]})]}),e.jsxs("button",{onClick:()=>{n(),i(!1)},className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(re,{className:"w-5 h-5"}),"Entrer l'ID manuellement"]})]}):e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"ID du sac"}),e.jsx("input",{type:"text",value:l,onChange:d=>t(d.target.value),placeholder:"Entrez l'ID du sac...",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-mono"}),e.jsx("button",{onClick:()=>i(!0),className:"mt-2 text-sm text-amber-600 hover:text-amber-700",children:"Utiliser le scanner"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:k,disabled:u,className:"flex-1 px-6 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:_,disabled:u||!l,className:"flex-1 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:u?"Traitement...":"Confirmer"})]})]})})})}export{Ae as default};
