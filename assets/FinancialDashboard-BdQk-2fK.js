import{r as c,s as p,j as e,L as u}from"./index-4fl_mEjj.js";import{A as y}from"./AdminLayout-Dxtdv1zb.js";import{C}from"./clock-T1Grp3ls.js";import{F as $}from"./file-text-CZNKAXPz.js";import{T as V}from"./trending-up-DXHHBpBo.js";import{C as H}from"./check-circle-Bjxp17BA.js";import{P as q}from"./package-WzBgJsOG.js";import{A as z}from"./alert-circle-CgDO6cwM.js";import{A as G}from"./arrow-right-BsDJS2e4.js";import{U as S}from"./users-BterXDAZ.js";import{B as D}from"./banknote-uCNahxc1.js";import"./x-B8X7lZOY.js";import"./createLucideIcon-DGm6Wim6.js";import"./menu-5lsVQnXG.js";import"./shield-BIjdbTUJ.js";import"./layout-dashboard-CUFDpKip.js";import"./truck-COZlEb6f.js";import"./wallet-DRWcPQQN.js";import"./store-DNK-TsLt.js";import"./home-Dlzpkrth.js";function pe(){const[F,k]=c.useState(!0),[l,T]=c.useState({totalCollectedFromClients:0,totalMerchantCharges:0,totalSettledByDelivery:0,totalPendingSettlement:0,pendingSettlementsCount:0,currentWeekExchanges:0,currentWeekCollections:0}),[g,A]=c.useState([]),[j,E]=c.useState([]);c.useEffect(()=>{R()},[]);const R=async()=>{try{const{data:s}=await p.from("delivery_persons").select("id, name, email"),{data:n}=await p.from("financial_transactions").select("*").order("created_at",{ascending:!1}),{data:i}=await p.from("delivery_person_settlements").select("*"),d=(n==null?void 0:n.filter(t=>t.transaction_type==="collection_from_client"&&t.status==="completed"))||[],f=d.reduce((t,a)=>t+(a.amount||0),0),W=((n==null?void 0:n.filter(t=>t.transaction_type==="merchant_charge"&&t.status==="completed"))||[]).reduce((t,a)=>t+(a.amount||0),0),b=(i==null?void 0:i.filter(t=>t.status==="confirmed"))||[],N=b.reduce((t,a)=>t+(a.amount||0),0),P=(i==null?void 0:i.filter(t=>t.status==="pending"))||[],o=new Date,m=new Date(o);m.setDate(o.getDate()-o.getDay()),m.setHours(0,0,0,0);const v=d.filter(t=>new Date(t.created_at)>=m),M=(s||[]).map(t=>{const a=d.filter(r=>r.delivery_person_id===t.id),x=b.filter(r=>r.delivery_person_id===t.id),_=a.reduce((r,h)=>r+(h.amount||0),0),w=x.reduce((r,h)=>r+(h.amount||0),0);return{id:t.id,name:t.name,email:t.email,total_collected:_,total_settled:w,pending_settlement:_-w,collections_count:a.length}}).filter(t=>t.total_collected>0||t.pending_settlement>0),U=(n||[]).slice(0,10).map(t=>{const a=s==null?void 0:s.find(x=>x.id===t.delivery_person_id);return{id:t.id,transaction_type:t.transaction_type,amount:t.amount,status:t.status,description:t.description||"",created_at:t.created_at,delivery_person_name:a==null?void 0:a.name}});T({totalCollectedFromClients:f,totalMerchantCharges:W,totalSettledByDelivery:N,totalPendingSettlement:f-N,pendingSettlementsCount:P.length,currentWeekExchanges:v.length,currentWeekCollections:v.reduce((t,a)=>t+(a.amount||0),0)}),A(M),E(U)}catch(s){console.error("Error fetching financial data:",s)}finally{k(!1)}},B=s=>({collection_from_client:"Encaissement client",settlement_to_partner:"Règlement partenaire",settlement_to_admin:"Règlement admin",merchant_charge:"Facturation marchand",refund_to_client:"Remboursement client",fee_deduction:"Déduction frais",invoice_generated:"Facture générée",invoice_paid:"Facture payée",adjustment:"Ajustement"})[s]||s,L=s=>{switch(s){case"collection_from_client":return"bg-emerald-100 text-emerald-700";case"settlement_to_partner":case"settlement_to_admin":return"bg-sky-100 text-sky-700";case"merchant_charge":return"bg-purple-100 text-purple-700";case"refund_to_client":return"bg-red-100 text-red-700";default:return"bg-slate-100 text-slate-700"}};return F?e.jsx(y,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})})}):e.jsx(y,{children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Dashboard Financier"}),e.jsx("p",{className:"text-slate-600",children:"Vue consolidée des finances de la plateforme"})]}),e.jsxs("div",{className:"flex gap-3 mt-4 md:mt-0",children:[e.jsxs(u,{to:"/admin/settlements",className:"inline-flex items-center gap-2 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors",children:[e.jsx(C,{className:"w-5 h-5"}),"Règlements",l.pendingSettlementsCount>0&&e.jsx("span",{className:"px-2 py-0.5 bg-amber-500 text-white text-xs rounded-full",children:l.pendingSettlementsCount})]}),e.jsxs(u,{to:"/admin/invoices",className:"inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx($,{className:"w-5 h-5"}),"Factures"]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Total Encaissé"}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:l.totalCollectedFromClients.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center",children:e.jsx(V,{className:"w-6 h-6 text-emerald-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Total Réglé"}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:l.totalSettledByDelivery.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-sky-100 rounded-lg flex items-center justify-center",children:e.jsx(H,{className:"w-6 h-6 text-sky-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"En Attente"}),e.jsx("p",{className:`text-2xl font-bold ${l.totalPendingSettlement>0?"text-amber-600":"text-slate-900"}`,children:l.totalPendingSettlement.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center",children:e.jsx(C,{className:"w-6 h-6 text-amber-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Cette Semaine"}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:l.currentWeekCollections.toFixed(2)}),e.jsxs("p",{className:"text-sm text-slate-500",children:[l.currentWeekExchanges," échanges"]})]}),e.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center",children:e.jsx(q,{className:"w-6 h-6 text-purple-600"})})]})})]}),l.pendingSettlementsCount>0&&e.jsx("div",{className:"bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-6 mb-8",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-6 h-6 text-amber-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-slate-900",children:[l.pendingSettlementsCount," règlement(s) en attente de confirmation"]}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Montant total: ",l.totalPendingSettlement.toFixed(2)," TND"]})]})]}),e.jsxs(u,{to:"/admin/settlements",className:"px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2",children:["Voir les règlements",e.jsx(G,{className:"w-5 h-5"})]})]})}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Soldes par Livreur"}),e.jsx(S,{className:"w-5 h-5 text-slate-400"})]}),g.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500",children:"Aucune activité financière"})]}):e.jsx("div",{className:"space-y-3",children:g.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:s.name}),e.jsxs("p",{className:"text-sm text-slate-500",children:[s.collections_count," encaissement(s)"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`font-semibold ${s.pending_settlement>0?"text-amber-600":"text-emerald-600"}`,children:[s.pending_settlement.toFixed(2)," TND"]}),e.jsx("p",{className:"text-xs text-slate-500",children:"en attente"})]})]},s.id))})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Transactions Récentes"}),e.jsx(D,{className:"w-5 h-5 text-slate-400"})]}),j.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(D,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500",children:"Aucune transaction"})]}):e.jsx("div",{className:"space-y-3",children:j.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${L(s.transaction_type)}`,children:B(s.transaction_type)}),e.jsx("div",{children:e.jsx("p",{className:"text-sm text-slate-600 truncate max-w-[150px]",children:s.description||s.delivery_person_name||"—"})})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-slate-900",children:[s.amount.toFixed(2)," TND"]}),e.jsx("p",{className:"text-xs text-slate-500",children:new Date(s.created_at).toLocaleDateString("fr-FR")})]})]},s.id))})]})]})]})})}export{pe as default};
