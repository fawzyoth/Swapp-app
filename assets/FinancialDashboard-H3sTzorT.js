import{s as i,j as e}from"./index-DZYJF6_c.js";import{u as L,r as n}from"./react-vendor-CTUriZ5h.js";import{D as v}from"./DeliveryLayout-BA2SGInF.js";import{T as M}from"./trending-up-9gPHMyOx.js";import{C as z}from"./check-circle-CyNeZd0p.js";import{C as U}from"./clock-Dhxn45-3.js";import{A as P}from"./alert-circle-_Iqic_ih.js";import{B as c}from"./banknote-JI0QWWz-.js";import{C as B}from"./calendar-upMk3ayk.js";import{P as O}from"./package-ChDCFdB3.js";import{A as G}from"./arrow-right-DmSRmNjw.js";import{S as H}from"./smartphone-B93dNxcm.js";import{C as V}from"./credit-card-D2z2xSBY.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./truck-CgEV9F53.js";import"./layout-dashboard-CqNl1jWq.js";import"./scan-line-Dhzz-_Ia.js";import"./wallet-CVOcG8S4.js";import"./home-9mW_oZwz.js";import"./log-out-BX30H4-p.js";function ue(){const u=L(),[y,w]=n.useState(!0),[p,_]=n.useState(null),[a,S]=n.useState({totalCollected:0,totalSettled:0,pendingSettlement:0,collectionsCount:0}),[g,C]=n.useState([]),[f,D]=n.useState([]),[A,m]=n.useState(!1),[o,j]=n.useState(!1);n.useEffect(()=>{F()},[]);const F=async()=>{try{const{data:{user:t}}=await i.auth.getUser();if(!t){u("/delivery/login");return}const{data:s}=await i.from("delivery_persons").select("id, name, email").eq("email",t.email).maybeSingle();if(!s){u("/delivery/login");return}_(s),await b(s.id)}catch(t){console.error("Error:",t)}finally{w(!1)}},b=async t=>{try{const{data:s}=await i.from("financial_transactions").select("amount").eq("delivery_person_id",t).eq("transaction_type","collection_from_client").eq("status","completed"),r=(s==null?void 0:s.reduce((l,h)=>l+(h.amount||0),0))||0,{data:d}=await i.from("delivery_person_settlements").select("amount").eq("delivery_person_id",t).eq("status","confirmed"),N=(d==null?void 0:d.reduce((l,h)=>l+(h.amount||0),0))||0,{data:x}=await i.from("delivery_verifications").select(`
          id,
          exchange_id,
          amount_collected,
          payment_method,
          created_at,
          exchanges:exchange_id (
            exchange_code,
            client_name
          )
        `).eq("delivery_person_id",t).eq("payment_collected",!0).gt("amount_collected",0).order("created_at",{ascending:!1}).limit(10),{data:R}=await i.from("delivery_person_settlements").select("*").eq("delivery_person_id",t).order("created_at",{ascending:!1}).limit(5);S({totalCollected:r,totalSettled:N,pendingSettlement:r-N,collectionsCount:(s==null?void 0:s.length)||0}),C((x==null?void 0:x.map(l=>({...l,exchange:Array.isArray(l.exchanges)?l.exchanges[0]:l.exchanges})))||[]),D(R||[])}catch(s){console.error("Error fetching financial data:",s)}},T=async()=>{if(a.pendingSettlement<=0){alert("Aucun montant à régler");return}j(!0);try{const t=new Date,s=new Date(t);s.setDate(t.getDate()-7);const{error:r}=await i.from("delivery_person_settlements").insert({delivery_person_id:p.id,settlement_type:"to_delivery_partner",amount:a.pendingSettlement,currency:"TND",period_start:s.toISOString().split("T")[0],period_end:t.toISOString().split("T")[0],exchanges_count:a.collectionsCount,status:"pending"});if(r)throw r;await b(p.id),m(!1),alert("Demande de règlement envoyée avec succès")}catch(t){console.error("Error requesting settlement:",t),alert("Erreur lors de la demande de règlement")}finally{j(!1)}},k=t=>{switch(t){case"cash":return e.jsx(c,{className:"w-4 h-4"});case"card":return e.jsx(V,{className:"w-4 h-4"});case"mobile_payment":return e.jsx(H,{className:"w-4 h-4"});default:return e.jsx(c,{className:"w-4 h-4"})}},q=t=>{switch(t){case"cash":return"Espèces";case"card":return"Carte";case"mobile_payment":return"Mobile";default:return"Autre"}},E=t=>{switch(t){case"confirmed":return e.jsx("span",{className:"px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium",children:"Confirmé"});case"pending":return e.jsx("span",{className:"px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium",children:"En attente"});case"disputed":return e.jsx("span",{className:"px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium",children:"Contesté"});default:return e.jsx("span",{className:"px-2 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-medium",children:t})}};return y?e.jsx(v,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600"})})}):e.jsx(v,{children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Mes Finances"}),e.jsx("p",{className:"text-slate-600",children:"Gérez vos encaissements et règlements"})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6 mb-8",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Total Encaissé"}),e.jsx("p",{className:"text-3xl font-bold text-slate-900",children:a.totalCollected.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center",children:e.jsx(M,{className:"w-6 h-6 text-emerald-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Total Réglé"}),e.jsx("p",{className:"text-3xl font-bold text-slate-900",children:a.totalSettled.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-sky-100 rounded-lg flex items-center justify-center",children:e.jsx(z,{className:"w-6 h-6 text-sky-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-1",children:"Solde en Attente"}),e.jsx("p",{className:`text-3xl font-bold ${a.pendingSettlement>0?"text-amber-600":"text-slate-900"}`,children:a.pendingSettlement.toFixed(2)}),e.jsx("p",{className:"text-sm text-slate-500",children:"TND"})]}),e.jsx("div",{className:"w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center",children:e.jsx(U,{className:"w-6 h-6 text-amber-600"})})]})})]}),a.pendingSettlement>0&&e.jsx("div",{className:"bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-6 mb-8",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{className:"w-6 h-6 text-amber-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-slate-900",children:["Vous avez ",a.pendingSettlement.toFixed(2)," TND à régler"]}),e.jsx("p",{className:"text-sm text-slate-600",children:"Demandez un règlement pour transférer ce montant"})]})]}),e.jsxs("button",{onClick:()=>m(!0),className:"px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2",children:[e.jsx(c,{className:"w-5 h-5"}),"Demander un Règlement"]})]})}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Derniers Encaissements"}),e.jsxs("span",{className:"text-sm text-slate-500",children:[a.collectionsCount," total"]})]}),g.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(c,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500",children:"Aucun encaissement"})]}):e.jsx("div",{className:"space-y-3",children:g.map(t=>{var s,r,d;return e.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center",children:k(t.payment_method)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:((s=t.exchange)==null?void 0:s.exchange_code)||"N/A"}),e.jsxs("p",{className:"text-sm text-slate-500",children:[((r=t.exchange)==null?void 0:r.client_name)||"Client"," • ",q(t.payment_method)]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-emerald-600",children:["+",(d=t.amount_collected)==null?void 0:d.toFixed(2)," TND"]}),e.jsx("p",{className:"text-xs text-slate-500",children:new Date(t.created_at).toLocaleDateString("fr-FR")})]})]},t.id)})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Historique des Règlements"})}),f.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(B,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500",children:"Aucun règlement"})]}):e.jsx("div",{className:"space-y-3",children:f.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-sky-100 rounded-lg flex items-center justify-center",children:e.jsx(O,{className:"w-5 h-5 text-sky-600"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-slate-900",children:[t.exchanges_count," échanges"]}),e.jsxs("p",{className:"text-sm text-slate-500",children:[new Date(t.period_start).toLocaleDateString("fr-FR")," - ",new Date(t.period_end).toLocaleDateString("fr-FR")]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-slate-900",children:[t.amount.toFixed(2)," TND"]}),E(t.status)]})]},t.id))})]})]}),A&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 bg-amber-100 rounded-lg",children:e.jsx(c,{className:"w-6 h-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:"Demander un Règlement"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Confirmez le montant à transférer"})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-amber-700 mb-1",children:"Montant à régler"}),e.jsxs("p",{className:"text-3xl font-bold text-amber-800",children:[a.pendingSettlement.toFixed(2)," TND"]}),e.jsxs("p",{className:"text-sm text-amber-600 mt-2",children:[a.collectionsCount," encaissement(s)"]})]})}),e.jsx("p",{className:"text-sm text-slate-600 mb-6",children:"Une fois soumise, cette demande sera vérifiée par l'administration. Le montant sera marqué comme réglé après confirmation."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>m(!1),disabled:o,className:"flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:T,disabled:o,className:"flex-1 px-4 py-3 bg-amber-600 hover:bg-amber-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2",children:o?"Traitement...":e.jsxs(e.Fragment,{children:["Confirmer",e.jsx(G,{className:"w-5 h-5"})]})})]})]})})})]})})}export{ue as default};
