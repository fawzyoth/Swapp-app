import{s as u,j as e}from"./index-CQq2JFMb.js";import{r as i,L as U}from"./react-vendor-CTUriZ5h.js";import{A as S}from"./AdminLayout-C3MUYMRb.js";import{P as D}from"./plus-BbVUCmx5.js";import{F as O}from"./filter-Cp7rfch8.js";import{F as g}from"./file-text-B3Ewreww.js";import{C as W}from"./calendar-upMk3ayk.js";import{E as q}from"./eye-B0fj8J_e.js";import{D as M}from"./download-BkxpqmAo.js";import{X as Y}from"./x-circle-D3f66Y07.js";import{C as $}from"./clock-Dhxn45-3.js";import{C as B}from"./check-circle-CyNeZd0p.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./shield-BNgLrtrc.js";import"./layout-dashboard-CqNl1jWq.js";import"./users-4zMWxYqH.js";import"./truck-CgEV9F53.js";import"./banknote-JI0QWWz-.js";import"./wallet-CVOcG8S4.js";import"./store-B-5iV_wL.js";import"./home-9mW_oZwz.js";function ge(){const[l,a]=i.useState(!0),[s,r]=i.useState([]),[n,k]=i.useState("all"),[F,p]=i.useState(!1),[f,j]=i.useState(!1),[c,T]=i.useState(new Date().getFullYear()),[o,I]=i.useState(R(new Date));i.useEffect(()=>{b()},[n]);const b=async()=>{try{let t=u.from("weekly_invoices").select("*").order("year",{ascending:!1}).order("week_number",{ascending:!1});n!=="all"&&(t=t.eq("status",n));const{data:d,error:x}=await t;if(x)throw x;r(d||[])}catch(t){console.error("Error fetching invoices:",t)}finally{a(!1)}},E=async()=>{j(!0);try{const{data:t}=await u.from("weekly_invoices").select("id").eq("year",c).eq("week_number",o).maybeSingle();if(t){alert("Une facture existe déjà pour cette semaine");return}const d=C(c,o),x=z(c,o),{data:m}=await u.from("delivery_verifications").select(`
          id,
          amount_collected,
          delivery_person_id,
          created_at,
          exchanges:exchange_id (
            id,
            exchange_code,
            merchant_id
          )
        `).eq("payment_collected",!0).gt("amount_collected",0).gte("created_at",d.toISOString()).lte("created_at",x.toISOString()),h=(m==null?void 0:m.reduce((A,P)=>A+(P.amount_collected||0),0))||0,N=h*.1,y=h*.05,v=h-N-y,w=`INV-${c}-W${o.toString().padStart(2,"0")}-001`,{data:L,error:_}=await u.from("weekly_invoices").insert({invoice_number:w,week_number:o,year:c,period_start:d.toISOString().split("T")[0],period_end:x.toISOString().split("T")[0],total_exchanges_handled:(m==null?void 0:m.length)||0,total_amount_collected:h,total_fees:N,total_commissions:y,net_payable:v,status:"generated",generated_at:new Date().toISOString()}).select().single();if(_)throw _;await u.from("financial_transactions").insert({invoice_id:L.id,transaction_type:"invoice_generated",amount:v,currency:"TND",direction:"debit",status:"completed",description:`Facture ${w} générée`}),p(!1),b(),alert("Facture générée avec succès")}catch(t){console.error("Error generating invoice:",t),alert("Erreur lors de la génération de la facture")}finally{j(!1)}},G=t=>{switch(t){case"paid":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium",children:[e.jsx(B,{className:"w-3 h-3"}),"Payée"]});case"generated":case"sent":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-sky-100 text-sky-700 rounded-full text-xs font-medium",children:[e.jsx($,{className:"w-3 h-3"}),t==="sent"?"Envoyée":"Générée"]});case"disputed":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium",children:[e.jsx(Y,{className:"w-3 h-3"}),"Contestée"]});case"draft":return e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-medium",children:"Brouillon"});default:return e.jsx("span",{className:"px-2 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-medium",children:t})}};return l?e.jsx(S,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})})}):e.jsx(S,{children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Factures"}),e.jsx("p",{className:"text-slate-600",children:"Gestion des factures hebdomadaires"})]}),e.jsxs("button",{onClick:()=>p(!0),className:"mt-4 md:mt-0 inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx(D,{className:"w-5 h-5"}),"Générer une Facture"]})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(O,{className:"w-5 h-5 text-slate-400"}),e.jsxs("select",{value:n,onChange:t=>k(t.target.value),className:"px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"draft",children:"Brouillon"}),e.jsx("option",{value:"generated",children:"Générée"}),e.jsx("option",{value:"sent",children:"Envoyée"}),e.jsx("option",{value:"paid",children:"Payée"}),e.jsx("option",{value:"disputed",children:"Contestée"})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-slate-50 border-b border-slate-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-6 py-4 text-sm font-semibold text-slate-900",children:"Facture"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-semibold text-slate-900",children:"Période"}),e.jsx("th",{className:"text-center px-6 py-4 text-sm font-semibold text-slate-900",children:"Échanges"}),e.jsx("th",{className:"text-right px-6 py-4 text-sm font-semibold text-slate-900",children:"Montant"}),e.jsx("th",{className:"text-center px-6 py-4 text-sm font-semibold text-slate-900",children:"Statut"}),e.jsx("th",{className:"text-right px-6 py-4 text-sm font-semibold text-slate-900",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:s.map(t=>e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center",children:e.jsx(g,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:t.invoice_number}),e.jsxs("p",{className:"text-sm text-slate-500",children:["Semaine ",t.week_number,", ",t.year]})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600",children:[e.jsx(W,{className:"w-4 h-4"}),new Date(t.period_start).toLocaleDateString("fr-FR")," -"," ",new Date(t.period_end).toLocaleDateString("fr-FR")]})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"font-medium text-slate-900",children:t.total_exchanges_handled})}),e.jsxs("td",{className:"px-6 py-4 text-right",children:[e.jsxs("p",{className:"font-semibold text-slate-900",children:[t.net_payable.toFixed(2)," TND"]}),e.jsxs("p",{className:"text-xs text-slate-500",children:["Collecté: ",t.total_amount_collected.toFixed(2)," TND"]})]}),e.jsx("td",{className:"px-6 py-4 text-center",children:G(t.status)}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(U,{to:`/admin/invoices/${t.id}`,className:"p-2 text-slate-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors",title:"Voir détails",children:e.jsx(q,{className:"w-5 h-5"})}),e.jsx("button",{className:"p-2 text-slate-600 hover:text-sky-600 hover:bg-sky-50 rounded-lg transition-colors",title:"Télécharger PDF",children:e.jsx(M,{className:"w-5 h-5"})})]})})]},t.id))})]})}),s.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(g,{className:"w-12 h-12 text-slate-300 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500",children:"Aucune facture trouvée"}),e.jsxs("button",{onClick:()=>p(!0),className:"inline-flex items-center gap-2 mt-4 px-4 py-2 text-purple-600 hover:text-purple-700",children:[e.jsx(D,{className:"w-5 h-5"}),"Générer une facture"]})]})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 bg-purple-100 rounded-lg",children:e.jsx(g,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:"Générer une Facture"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Sélectionnez la semaine à facturer"})]})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Année"}),e.jsx("select",{value:c,onChange:t=>T(parseInt(t.target.value)),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:[2024,2025,2026].map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Semaine"}),e.jsx("select",{value:o,onChange:t=>I(parseInt(t.target.value)),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:Array.from({length:52},(t,d)=>d+1).map(t=>e.jsxs("option",{value:t,children:["Semaine ",t]},t))})]})]}),e.jsx("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6",children:e.jsxs("p",{className:"text-sm text-slate-600",children:["La facture inclura tous les encaissements effectués durant la semaine"," ",o," de ",c,"."]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>p(!1),disabled:f,className:"flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:E,disabled:f,className:"flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:f?"Génération...":"Générer"})]})]})})})]})})}function R(l){const a=new Date(Date.UTC(l.getFullYear(),l.getMonth(),l.getDate())),s=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-s);const r=new Date(Date.UTC(a.getUTCFullYear(),0,1));return Math.ceil(((a.getTime()-r.getTime())/864e5+1)/7)}function C(l,a){const s=new Date(l,0,1+(a-1)*7),r=s.getDay(),n=s;return r<=4?n.setDate(s.getDate()-s.getDay()+1):n.setDate(s.getDate()+8-s.getDay()),n}function z(l,a){const s=C(l,a),r=new Date(s);return r.setDate(s.getDate()+6),r.setHours(23,59,59,999),r}export{ge as default};
