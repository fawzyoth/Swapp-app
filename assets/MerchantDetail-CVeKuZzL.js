import{s as o,j as e}from"./index-zDZ3Lj_p.js";import{h as k,u as D,r as c,L as f}from"./react-vendor-CTUriZ5h.js";import{Q as P}from"./qr-display-BZBHW9NW.js";import{A as p}from"./AdminLayout-CvWZnuk_.js";import{A as E}from"./arrow-left-CxjwE-xR.js";import{S as L}from"./square-pen-CeNeTQJP.js";import{S as $}from"./store-B-5iV_wL.js";import{Q as A}from"./qr-code-ByVDLSXi.js";import{D as U}from"./download-BkxpqmAo.js";import{P as b}from"./package-ChDCFdB3.js";import{C as M}from"./clock-Dhxn45-3.js";import{C as Q}from"./check-circle-CyNeZd0p.js";import{X as T}from"./x-circle-D3f66Y07.js";import{T as I}from"./trending-up-9gPHMyOx.js";import{U as z}from"./users-4zMWxYqH.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./shield-BNgLrtrc.js";import"./layout-dashboard-CqNl1jWq.js";import"./truck-CgEV9F53.js";import"./banknote-JI0QWWz-.js";import"./file-text-B3Ewreww.js";import"./home-9mW_oZwz.js";function he(){const{id:n}=k(),N=D(),m=c.useRef(null),[t,j]=c.useState(null),[r,v]=c.useState([]),[w,y]=c.useState(!0);c.useEffect(()=>{C()},[n]);const C=async()=>{try{const[s,d]=await Promise.all([o.from("merchants").select("*").eq("id",n).single(),o.from("exchanges").select("*").eq("merchant_id",n).order("created_at",{ascending:!1})]);if(s.data){if(!s.data.qr_code_data){const l=`SWAPP-${s.data.id.slice(0,8).toUpperCase()}`;await o.from("merchants").update({qr_code_data:l}).eq("id",n),s.data.qr_code_data=l}j(s.data)}v(d.data||[])}finally{y(!1)}},_=async()=>{const s=`SWAPP-${t.id.slice(0,8).toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;await o.from("merchants").update({qr_code_data:s}).eq("id",n),j({...t,qr_code_data:s})},R=()=>{if(!m.current)return;const s=m.current.querySelector("svg");if(!s)return;const d=new XMLSerializer().serializeToString(s),l=document.createElement("canvas"),x=l.getContext("2d"),i=new Image;i.onload=()=>{l.width=i.width,l.height=i.height,x==null||x.drawImage(i,0,0);const S=l.toDataURL("image/png"),h=document.createElement("a");h.download=`qr-${t.name.replace(/\s+/g,"-").toLowerCase()}.png`,h.href=S,h.click()},i.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(d)))},a={total:r.length,pending:r.filter(s=>s.status==="pending").length,validated:r.filter(s=>["validated","preparing","in_transit","completed"].includes(s.status)).length,rejected:r.filter(s=>s.status==="rejected").length,completed:r.filter(s=>s.status==="completed").length,uniqueClients:[...new Set(r.map(s=>s.client_phone))].length},g=a.total>0?Math.round(a.validated/a.total*100):0,u=a.total>0?Math.round(a.completed/a.total*100):0,q=s=>{const d={pending:"bg-amber-100 text-amber-700",validated:"bg-sky-100 text-sky-700",preparing:"bg-purple-100 text-purple-700",in_transit:"bg-indigo-100 text-indigo-700",completed:"bg-emerald-100 text-emerald-700",rejected:"bg-red-100 text-red-700",returned:"bg-slate-100 text-slate-700"},l={pending:"En attente",validated:"Validé",preparing:"Préparation",in_transit:"En route",completed:"Complété",rejected:"Rejeté",returned:"Retourné"};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${d[s]||"bg-slate-100 text-slate-700"}`,children:l[s]||s})};return w?e.jsx(p,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})})}):t?e.jsx(p,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[e.jsx("button",{onClick:()=>N("/admin/merchants"),className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(E,{className:"w-5 h-5 text-slate-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:t.name}),e.jsx("p",{className:"text-slate-600",children:t.email})]}),e.jsxs(f,{to:`/admin/merchant/${n}/edit`,className:"inline-flex items-center gap-2 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors",children:[e.jsx(L,{className:"w-4 h-4"}),"Modifier"]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center",children:e.jsx($,{className:"w-8 h-8 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:t.name}),e.jsx("p",{className:"text-slate-500",children:t.phone||"Pas de téléphone"})]})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-500",children:"Email"}),e.jsx("span",{className:"text-slate-900",children:t.email})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-500",children:"Inscrit le"}),e.jsx("span",{className:"text-slate-900",children:new Date(t.created_at).toLocaleDateString("fr-FR")})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"QR Code"}),e.jsx(A,{className:"w-5 h-5 text-purple-600"})]}),e.jsx("div",{ref:m,className:"flex justify-center mb-4 p-4 bg-white rounded-lg border border-slate-200",children:e.jsx(P,{value:`https://swapp-test-app.netlify.app/client/exchange/new?merchant=${t.id}`,size:200,level:"H",includeMargin:!0})}),e.jsx("p",{className:"text-center text-sm text-slate-500 mb-4 font-mono",children:t.qr_code_data}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:R,className:"flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:[e.jsx(U,{className:"w-4 h-4"}),"Télécharger"]}),e.jsx("button",{onClick:_,className:"px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors",children:"Regénérer"})]})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(b,{className:"w-5 h-5 text-sky-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Total"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:a.total})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(M,{className:"w-5 h-5 text-amber-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"En attente"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:a.pending})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Q,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Validés"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:a.validated})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(T,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Rejetés"})]}),e.jsx("p",{className:"text-2xl font-bold text-slate-900",children:a.rejected})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Performance"}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(I,{className:"w-5 h-5 text-emerald-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Taux de validation"})]}),e.jsxs("p",{className:"text-3xl font-bold text-emerald-600",children:[g,"%"]}),e.jsx("div",{className:"mt-2 h-2 bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-emerald-500 rounded-full transition-all",style:{width:`${g}%`}})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(b,{className:"w-5 h-5 text-sky-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Taux de complétion"})]}),e.jsxs("p",{className:"text-3xl font-bold text-sky-600",children:[u,"%"]}),e.jsx("div",{className:"mt-2 h-2 bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-sky-500 rounded-full transition-all",style:{width:`${u}%`}})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(z,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"text-sm text-slate-600",children:"Clients uniques"})]}),e.jsx("p",{className:"text-3xl font-bold text-purple-600",children:a.uniqueClients})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden",children:[e.jsx("div",{className:"p-6 border-b border-slate-200",children:e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Échanges récents"})}),r.length>0?e.jsx("div",{className:"divide-y divide-slate-200",children:r.slice(0,10).map(s=>e.jsx("div",{className:"p-4 hover:bg-slate-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:s.client_name}),e.jsx("p",{className:"text-sm text-slate-500",children:s.product_name||s.reason})]}),e.jsxs("div",{className:"text-right",children:[q(s.status),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:new Date(s.created_at).toLocaleDateString("fr-FR")})]})]})},s.id))}):e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Aucun échange pour ce commerçant"})]})]})]})]})}):e.jsx(p,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-500",children:"E-commerçant non trouvé"}),e.jsx(f,{to:"/admin/merchants",className:"text-purple-600 hover:text-purple-700 mt-2 inline-block",children:"Retour à la liste"})]})})}export{he as default};
