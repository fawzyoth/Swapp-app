import{d as z,u as H,r as a,s as o,j as e,L as g,n as K,k as U,P as V}from"./index-CJfzlPPb.js";import{A as _}from"./AdminLayout-Cott1vpl.js";import{A as W}from"./arrow-left-DiPsJ-JR.js";import{F as G}from"./file-text-RY1QLM_O.js";import{C as T}from"./check-B51OF9NW.js";import{B as E}from"./banknote-D96JuROO.js";import{B as J}from"./building-2-CriIwvHk.js";import{M as Q}from"./mail-BTPVHPwA.js";import{P as ee}from"./phone-5_HaUiYR.js";import{C as te}from"./credit-card-BVY_nKoz.js";import{C}from"./clock-DGCijsjM.js";import{R as se}from"./receipt-DrXCqJW1.js";import{D as ae}from"./download-Deo1mom1.js";import{A as ne}from"./alert-circle-DIx6FHgM.js";import{C as P}from"./check-circle-CuNCG6cC.js";import"./x-D_OLgdW5.js";import"./createLucideIcon-Bria8yYC.js";import"./menu-746gIWo9.js";import"./shield-njQ-jaoh.js";import"./layout-dashboard-D7L7G9Xc.js";import"./users-Cf_LtCuF.js";import"./truck-BlUigVNz.js";import"./wallet-O54_QbzE.js";import"./store-Qiz61_52.js";import"./home-CrXiDTzT.js";const k={id:"1",merchant_id:"m1",payment_number:"PAY-2025-P24-001",period_number:2,year:2025,month:12,period_start:"2025-12-01",period_end:"2025-12-15",total_exchanges:8,total_collected:245,total_swapp_fees:72,amount_due:173,status:"pending",created_at:new Date().toISOString(),merchant:{id:"m1",email:"techstore@example.com",name:"TechStore",phone:"+216 98 123 456",business_name:"TechStore Tunisie",business_address:"12 Rue de la Liberté",business_city:"Tunis",created_at:""}},M=[{id:"1",payment_id:"1",exchange_id:"e1",exchange_code:"EXC-2025-001",client_name:"Ahmed Benali",amount_collected:35,swapp_fee:9,merchant_amount:26,collection_date:"2025-12-02T14:30:00Z",created_at:new Date().toISOString()},{id:"2",payment_id:"1",exchange_id:"e2",exchange_code:"EXC-2025-002",client_name:"Sami Khalil",amount_collected:25,swapp_fee:9,merchant_amount:16,collection_date:"2025-12-03T10:15:00Z",created_at:new Date().toISOString()},{id:"3",payment_id:"1",exchange_id:"e3",exchange_code:"EXC-2025-003",client_name:"Leila Mansouri",amount_collected:9,swapp_fee:9,merchant_amount:0,collection_date:"2025-12-04T16:45:00Z",created_at:new Date().toISOString()},{id:"4",payment_id:"1",exchange_id:"e4",exchange_code:"EXC-2025-004",client_name:"Karim Jebali",amount_collected:45,swapp_fee:9,merchant_amount:36,collection_date:"2025-12-05T11:00:00Z",created_at:new Date().toISOString()},{id:"5",payment_id:"1",exchange_id:"e5",exchange_code:"EXC-2025-005",client_name:"Fatma Trabelsi",amount_collected:30,swapp_fee:9,merchant_amount:21,collection_date:"2025-12-06T09:30:00Z",created_at:new Date().toISOString()},{id:"6",payment_id:"1",exchange_id:"e6",exchange_code:"EXC-2025-006",client_name:"Youssef Hamdi",amount_collected:50,swapp_fee:9,merchant_amount:41,collection_date:"2025-12-08T15:20:00Z",created_at:new Date().toISOString()},{id:"7",payment_id:"1",exchange_id:"e7",exchange_code:"EXC-2025-007",client_name:"Nadia Bouazizi",amount_collected:20,swapp_fee:9,merchant_amount:11,collection_date:"2025-12-10T13:45:00Z",created_at:new Date().toISOString()},{id:"8",payment_id:"1",exchange_id:"e8",exchange_code:"EXC-2025-008",client_name:"Mohamed Sassi",amount_collected:31,swapp_fee:9,merchant_amount:22,collection_date:"2025-12-12T08:00:00Z",created_at:new Date().toISOString()}];function Pe(){var j,N,b,y,w,v,S,D;const{id:m}=z();H();const[t,l]=a.useState(null),[x,h]=a.useState([]),[A,F]=a.useState(!0),[c,d]=a.useState(!1),[I,p]=a.useState(!1),[u,O]=a.useState("bank_transfer"),[r,R]=a.useState("");a.useEffect(()=>{f()},[m]);const f=async()=>{try{const{data:s,error:n}=await o.from("merchant_payments").select(`
          *,
          merchant:merchants(*)
        `).eq("id",m).single();if(n)console.log("Using demo data - merchant_payments table not created yet"),l(k),h(M);else{l(s);const{data:i}=await o.from("merchant_payment_items").select("*").eq("payment_id",m).order("collection_date",{ascending:!0});h(i||[])}}catch(s){console.error("Error fetching data:",s),l(k),h(M)}finally{F(!1)}},L=async()=>{if(t){d(!0);try{const{error:s}=await o.from("merchant_payments").update({status:"approved",approved_at:new Date().toISOString()}).eq("id",t.id);s?l({...t,status:"approved",approved_at:new Date().toISOString()}):await f()}catch(s){console.error("Error approving payment:",s)}finally{d(!1)}}},B=async()=>{if(!(!t||!r)){d(!0);try{const{error:s}=await o.from("merchant_payments").update({status:"paid",paid_at:new Date().toISOString(),payment_method:u,payment_reference:r}).eq("id",t.id);s?l({...t,status:"paid",paid_at:new Date().toISOString(),payment_method:u,payment_reference:r}):await f(),p(!1)}catch(s){console.error("Error marking as paid:",s)}finally{d(!1)}}},X=s=>{const n={pending:"bg-yellow-100 text-yellow-800",approved:"bg-blue-100 text-blue-800",paid:"bg-green-100 text-green-800",disputed:"bg-red-100 text-red-800"},i={pending:e.jsx(C,{className:"w-4 h-4"}),approved:e.jsx(P,{className:"w-4 h-4"}),paid:e.jsx(P,{className:"w-4 h-4"}),disputed:e.jsx(ne,{className:"w-4 h-4"})};return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${n[s]}`,children:[i[s],V[s]]})},Z=s=>new Date(s).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}),q=s=>new Date(s).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),$=s=>{const n=new Date(s.period_start),i=new Date(s.period_end),Y=n.toLocaleDateString("fr-FR",{month:"long"});return`${n.getDate()} - ${i.getDate()} ${Y} ${s.year}`};return A?e.jsx(_,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600"})})}):t?e.jsx(_,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(g,{to:"/admin/merchant-payments",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 mb-4",children:[e.jsx(W,{className:"w-4 h-4"}),"Retour aux paiements"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-slate-900 flex items-center gap-3",children:[e.jsx(G,{className:"w-7 h-7"}),t.payment_number]}),e.jsxs("p",{className:"text-slate-600 mt-1",children:["Période: ",$(t)]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[X(t.status),t.status==="pending"&&e.jsxs("button",{onClick:L,disabled:c,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:[e.jsx(T,{className:"w-4 h-4"}),"Approuver"]}),(t.status==="pending"||t.status==="approved")&&e.jsxs("button",{onClick:()=>p(!0),disabled:c,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50",children:[e.jsx(E,{className:"w-4 h-4"}),"Marquer Payé"]})]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow p-6",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 mb-4 flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5"}),"Marchand"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900 text-lg",children:((j=t.merchant)==null?void 0:j.business_name)||((N=t.merchant)==null?void 0:N.name)}),e.jsx("p",{className:"text-slate-500 text-sm",children:(b=t.merchant)==null?void 0:b.name})]}),((y=t.merchant)==null?void 0:y.email)&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx(Q,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t.merchant.email})]}),((w=t.merchant)==null?void 0:w.phone)&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t.merchant.phone})]}),((v=t.merchant)==null?void 0:v.business_address)&&e.jsxs("p",{className:"text-sm text-slate-500",children:[t.merchant.business_address,t.merchant.business_city&&`, ${t.merchant.business_city}`]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow p-6",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 mb-4 flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"Résumé Financier"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Total encaissé"}),e.jsxs("span",{className:"font-medium text-slate-900",children:[t.total_collected.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsxs("span",{className:"text-slate-600",children:["Frais SWAPP (",K," × ",t.total_exchanges,")"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["- ",t.total_swapp_fees.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-3 bg-green-50 -mx-2 px-2 rounded-lg",children:[e.jsx("span",{className:"font-semibold text-green-800",children:"À verser"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:[t.amount_due.toFixed(2)," TND"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow p-6",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5"}),"Paiement"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Échanges"}),e.jsx("span",{className:"font-medium text-slate-900",children:t.total_exchanges})]}),t.payment_method&&e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Méthode"}),e.jsx("span",{className:"font-medium text-slate-900",children:U[t.payment_method]})]}),t.payment_reference&&e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Référence"}),e.jsx("span",{className:"font-mono text-sm text-slate-900",children:t.payment_reference})]}),t.paid_at&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"text-slate-600",children:"Payé le"}),e.jsx("span",{className:"font-medium text-green-600",children:Z(t.paid_at)})]}),t.status==="pending"&&e.jsxs("div",{className:"py-3 text-center text-yellow-700 bg-yellow-50 rounded-lg",children:[e.jsx(C,{className:"w-4 h-4 inline mr-2"}),"En attente de traitement"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5"}),"Détail des Échanges (",x.length,")"]}),e.jsxs("button",{className:"text-sm text-sky-600 hover:text-sky-700 flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),"Exporter PDF"]})]}),x.length===0?e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Aucun détail disponible"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Code Échange"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Client"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Encaissé"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Frais"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Net Marchand"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:x.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(g,{to:`/admin/exchanges/${s.exchange_id}`,className:"font-mono text-sm text-sky-600 hover:underline",children:s.exchange_code})}),e.jsx("td",{className:"px-4 py-3 text-slate-700",children:s.client_name}),e.jsx("td",{className:"px-4 py-3 text-slate-600 text-sm",children:q(s.collection_date)}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-slate-900",children:[s.amount_collected.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right text-red-600",children:["-",s.swapp_fee.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-green-700",children:[s.merchant_amount.toFixed(2)," TND"]})]},s.id))}),e.jsx("tfoot",{className:"bg-slate-100",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 font-semibold text-slate-900",children:"Total"}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-slate-900",children:[t.total_collected.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-red-600",children:["-",t.total_swapp_fees.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-green-700",children:[t.amount_due.toFixed(2)," TND"]})]})})]})})]}),t.notes&&e.jsxs("div",{className:"mt-6 bg-slate-50 rounded-xl p-4",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-2",children:"Notes"}),e.jsx("p",{className:"text-slate-600",children:t.notes})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-4",children:"Marquer comme Payé"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Méthode de paiement"}),e.jsxs("select",{value:u,onChange:s=>O(s.target.value),className:"w-full border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500",children:[e.jsx("option",{value:"bank_transfer",children:"Virement Bancaire"}),e.jsx("option",{value:"check",children:"Chèque"}),e.jsx("option",{value:"cash",children:"Espèces"}),e.jsx("option",{value:"mobile",children:"Paiement Mobile"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Référence de paiement *"}),e.jsx("input",{type:"text",value:r,onChange:s=>R(s.target.value),placeholder:"Ex: VIR-2025-1218-001",className:"w-full border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-500"})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg",children:[e.jsxs("p",{className:"text-green-800 font-medium",children:["Montant: ",t.amount_due.toFixed(2)," TND"]}),e.jsxs("p",{className:"text-green-700 text-sm",children:["À verser à"," ",((S=t.merchant)==null?void 0:S.business_name)||((D=t.merchant)==null?void 0:D.name)]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>p(!1),className:"flex-1 px-4 py-2 border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors",children:"Annuler"}),e.jsx("button",{onClick:B,disabled:!r||c,className:"flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:c?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4"}),"Confirmer"]})})]})]})})]})}):e.jsx(_,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-600",children:"Paiement non trouvé"}),e.jsx(g,{to:"/admin/merchant-payments",className:"text-sky-600 hover:underline mt-2 inline-block",children:"Retour à la liste"})]})})}export{Pe as default};
