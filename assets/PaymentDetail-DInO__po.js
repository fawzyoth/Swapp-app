import{d as Y,u as U,r as l,s as d,j as e,L as T,D as V,i as H,k as K,P as J}from"./index-CQ_LRKqG.js";import{M as N}from"./MerchantLayout-BY2gk5uq.js";import{A as W}from"./arrow-left-BXzShBGO.js";import{F as G}from"./file-text-C13V5xI-.js";import{B as Q}from"./banknote-B-tG0m_s.js";import{C as ee}from"./credit-card-Cyy8sGIb.js";import{C}from"./clock-CzMshNXu.js";import{R as te}from"./receipt-B0l7QP4Y.js";import{D as ae}from"./download-BuNQnuB6.js";import{A as se}from"./alert-circle-D4GLTGUl.js";import{C as b}from"./check-circle-CNrQZjEC.js";import"./x-BXOCxbM_.js";import"./createLucideIcon-_6ROX8yg.js";import"./menu-BxfI3nIZ.js";import"./store-Cz-oRZt_.js";import"./layout-dashboard-BZxJ5DpE.js";import"./package-euHH1Ynp.js";import"./truck-Cnf3_ycc.js";import"./users-DVzjBHSD.js";import"./message-square-DaG2BKN2.js";import"./star-z966A4YF.js";import"./video-BzEE77Gk.js";import"./log-out-DgqNs_DR.js";const A={id:"1",merchant_id:"demo",payment_number:"PAY-2025-P24-001",period_number:2,year:2025,month:12,period_start:"2025-12-01",period_end:"2025-12-15",total_exchanges:8,total_collected:245,total_swapp_fees:72,total_delivery_fees:40,amount_due:133,status:"paid",paid_at:"2025-12-18T10:30:00Z",payment_method:"cash",merchant_accepted:!1,created_at:new Date().toISOString()},F=[{id:"1",payment_id:"1",exchange_id:"e1",exchange_code:"EXC-2025-001",client_name:"Ahmed Benali",amount_collected:35,swapp_fee:9,merchant_amount:26,collection_date:"2025-12-02T14:30:00Z",created_at:new Date().toISOString()},{id:"2",payment_id:"1",exchange_id:"e2",exchange_code:"EXC-2025-002",client_name:"Sami Khalil",amount_collected:25,swapp_fee:9,merchant_amount:16,collection_date:"2025-12-03T10:15:00Z",created_at:new Date().toISOString()},{id:"3",payment_id:"1",exchange_id:"e3",exchange_code:"EXC-2025-003",client_name:"Leila Mansouri",amount_collected:9,swapp_fee:9,merchant_amount:0,collection_date:"2025-12-04T16:45:00Z",created_at:new Date().toISOString()},{id:"4",payment_id:"1",exchange_id:"e4",exchange_code:"EXC-2025-004",client_name:"Karim Jebali",amount_collected:45,swapp_fee:9,merchant_amount:36,collection_date:"2025-12-05T11:00:00Z",created_at:new Date().toISOString()},{id:"5",payment_id:"1",exchange_id:"e5",exchange_code:"EXC-2025-005",client_name:"Fatma Trabelsi",amount_collected:30,swapp_fee:9,merchant_amount:21,collection_date:"2025-12-06T09:30:00Z",created_at:new Date().toISOString()},{id:"6",payment_id:"1",exchange_id:"e6",exchange_code:"EXC-2025-006",client_name:"Youssef Hamdi",amount_collected:50,swapp_fee:9,merchant_amount:41,collection_date:"2025-12-08T15:20:00Z",created_at:new Date().toISOString()},{id:"7",payment_id:"1",exchange_id:"e7",exchange_code:"EXC-2025-007",client_name:"Nadia Bouazizi",amount_collected:20,swapp_fee:9,merchant_amount:11,collection_date:"2025-12-10T13:45:00Z",created_at:new Date().toISOString()},{id:"8",payment_id:"1",exchange_id:"e8",exchange_code:"EXC-2025-008",client_name:"Mohamed Sassi",amount_collected:31,swapp_fee:9,merchant_amount:22,collection_date:"2025-12-12T08:00:00Z",created_at:new Date().toISOString()}];function Ee(){const{id:o}=Y(),I=U(),[t,m]=l.useState(null),[u,r]=l.useState([]),[L,M]=l.useState(!0),[O,_]=l.useState(!1),[x,f]=l.useState(""),[y,w]=l.useState(!1),[v,D]=l.useState(!1);l.useEffect(()=>{P(),k()},[o]);const P=async()=>{const{data:{session:a}}=await d.auth.getSession();a||I("/merchant/login")},k=async()=>{try{const{data:a,error:i}=await d.from("merchant_payments").select("*").eq("id",o).single();if(i)console.log("Using demo data - merchant_payments table not created yet"),m(A),r(F);else{m(a);const{data:c,error:g}=await d.from("merchant_payment_items").select("*").eq("payment_id",o).order("collection_date",{ascending:!0});if(!g&&c&&c.length>0)r(c);else{const{data:j}=await d.from("exchanges").select(`
              id,
              exchange_code,
              client_name,
              created_at,
              delivery_verifications!inner(
                payment_collected,
                amount_collected,
                created_at
              )
            `).eq("merchant_id",a.merchant_id).gte("created_at",a.period_start).lte("created_at",a.period_end+"T23:59:59").eq("delivery_verifications.payment_collected",!0);if(j&&j.length>0){const p=j.map((n,h)=>{var E;const s=(E=n.delivery_verifications)==null?void 0:E[0],S=(s==null?void 0:s.amount_collected)||9;return{id:`gen-${h}`,payment_id:o,exchange_id:n.id,exchange_code:n.exchange_code,client_name:n.client_name,amount_collected:S,swapp_fee:9,merchant_amount:Math.max(0,S-9),collection_date:(s==null?void 0:s.created_at)||n.created_at,created_at:new Date().toISOString()}});r(p)}else{const p=a.total_exchanges||0;if(p>0){const n=a.total_collected/p,h=[];for(let s=0;s<p;s++)h.push({id:`demo-${s}`,payment_id:o,exchange_id:`ex-${s}`,exchange_code:`EXC-${a.year}-${String(s+1).padStart(3,"0")}`,client_name:`Client ${s+1}`,amount_collected:n,swapp_fee:9,merchant_amount:Math.max(0,n-9),collection_date:a.period_start,created_at:new Date().toISOString()});r(h)}else r([])}}}}catch(a){console.error("Error fetching data:",a),m(A),r(F)}finally{M(!1)}},R=a=>{const i={pending:"bg-yellow-100 text-yellow-800",approved:"bg-blue-100 text-blue-800",paid:"bg-emerald-100 text-emerald-800",accepted:"bg-green-100 text-green-800",disputed:"bg-red-100 text-red-800"},c={pending:e.jsx(C,{className:"w-4 h-4"}),approved:e.jsx(b,{className:"w-4 h-4"}),paid:e.jsx(b,{className:"w-4 h-4"}),accepted:e.jsx(b,{className:"w-4 h-4"}),disputed:e.jsx(se,{className:"w-4 h-4"})};return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${i[a]}`,children:[c[a],J[a]]})},$=(t==null?void 0:t.status)==="paid"&&!(t!=null&&t.merchant_accepted),q=async()=>{if(t){w(!0);try{const{error:a}=await d.from("merchant_payments").update({merchant_accepted:!0,merchant_accepted_at:new Date().toISOString(),status:"accepted"}).eq("id",t.id);a||m({...t,merchant_accepted:!0,merchant_accepted_at:new Date().toISOString(),status:"accepted"})}finally{w(!1)}}},X=async()=>{if(!(!t||!x.trim())){D(!0);try{const{error:a}=await d.from("merchant_payments").update({status:"disputed",dispute_reason:x}).eq("id",t.id);a||(m({...t,status:"disputed",dispute_reason:x}),_(!1),f(""))}finally{D(!1)}}},Z=a=>new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}),z=a=>new Date(a).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),B=a=>{const i=new Date(a.period_start),c=new Date(a.period_end),g=i.toLocaleDateString("fr-FR",{month:"long"});return`${i.getDate()} - ${c.getDate()} ${g} ${a.year}`};return L?e.jsx(N,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600"})})}):t?e.jsx(N,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(T,{to:"/merchant/payments",className:"inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 mb-4",children:[e.jsx(W,{className:"w-4 h-4"}),"Retour aux paiements"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-slate-900 flex items-center gap-3",children:[e.jsx(G,{className:"w-7 h-7"}),t.payment_number]}),e.jsxs("p",{className:"text-slate-600 mt-1",children:["Période: ",B(t)]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[R(t.status),t.merchant_accepted&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"✓ Accepté par vous"})]})]})]}),$&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-amber-900",children:"Action requise"}),e.jsxs("p",{className:"text-sm text-amber-700 mt-1",children:["Vous avez reçu un paiement de"," ",e.jsxs("strong",{children:[t.amount_due.toFixed(2)," TND"]}),". Veuillez confirmer la réception ou signaler un problème."]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>_(!0),className:"px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors",children:"Contester"}),e.jsx("button",{onClick:q,disabled:y,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50",children:y?"Confirmation...":"Accepter le paiement"})]})]})}),O&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-4",children:"Contester le paiement"}),e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Veuillez expliquer la raison de votre contestation. Notre équipe examinera votre demande."}),e.jsx("textarea",{value:x,onChange:a=>f(a.target.value),placeholder:"Expliquez le problème rencontré...",className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:4}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx("button",{onClick:()=>{_(!1),f("")},className:"flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50",children:"Annuler"}),e.jsx("button",{onClick:X,disabled:!x.trim()||v,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50",children:v?"Envoi...":"Envoyer la contestation"})]})]})}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow p-6",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 mb-4 flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Résumé Financier"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Total encaissé clients"}),e.jsxs("span",{className:"font-medium text-slate-900",children:[t.total_collected.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsxs("span",{className:"text-slate-600",children:["Frais Plateforme (",V," TND ×"," ",t.total_exchanges,")"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["- ",t.total_swapp_fees.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsxs("span",{className:"text-slate-600",children:["Frais Livraison (",H," TND ×"," ",t.total_exchanges,")"]}),e.jsxs("span",{className:"font-medium text-red-600",children:["- ",(t.total_delivery_fees||0).toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between items-center py-3 bg-green-50 -mx-2 px-2 rounded-lg",children:[e.jsx("span",{className:"font-semibold text-green-800",children:"Montant versé"}),e.jsxs("span",{className:"text-xl font-bold text-green-700",children:[t.amount_due.toFixed(2)," TND"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow p-6",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 mb-4 flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5"}),"Informations de Paiement"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Nombre d'échanges"}),e.jsx("span",{className:"font-medium text-slate-900",children:t.total_exchanges})]}),t.payment_method&&e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Méthode de paiement"}),e.jsx("span",{className:"font-medium text-slate-900",children:K[t.payment_method]||t.payment_method})]}),t.payment_reference&&e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-slate-100",children:[e.jsx("span",{className:"text-slate-600",children:"Référence"}),e.jsx("span",{className:"font-mono text-sm text-slate-900",children:t.payment_reference})]}),t.paid_at&&e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"text-slate-600",children:"Date de paiement"}),e.jsx("span",{className:"font-medium text-green-600",children:Z(t.paid_at)})]}),t.status==="pending"&&e.jsxs("div",{className:"py-2 text-center text-yellow-700 bg-yellow-50 rounded-lg",children:[e.jsx(C,{className:"w-4 h-4 inline mr-2"}),"En attente de traitement"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"font-semibold text-slate-900 flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5"}),"Détail des Échanges (",u.length,")"]}),e.jsxs("button",{className:"text-sm text-sky-600 hover:text-sky-700 flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),"Exporter"]})]}),u.length===0?e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Aucun détail disponible"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Code Échange"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Client"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Encaissé"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Frais SWAPP"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Net"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:u.map(a=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm text-slate-900",children:a.exchange_code}),e.jsx("td",{className:"px-4 py-3 text-slate-700",children:a.client_name}),e.jsx("td",{className:"px-4 py-3 text-slate-600 text-sm",children:z(a.collection_date)}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-slate-900",children:[a.amount_collected.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right text-red-600",children:["-",a.swapp_fee.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-green-700",children:[a.merchant_amount.toFixed(2)," TND"]})]},a.id))}),e.jsx("tfoot",{className:"bg-slate-100",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 font-semibold text-slate-900",children:"Total"}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-slate-900",children:[t.total_collected.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-red-600",children:["-",t.total_swapp_fees.toFixed(2)," TND"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold text-green-700",children:[t.amount_due.toFixed(2)," TND"]})]})})]})})]}),t.notes&&e.jsxs("div",{className:"mt-6 bg-slate-50 rounded-xl p-4",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-2",children:"Notes"}),e.jsx("p",{className:"text-slate-600",children:t.notes})]})]})}):e.jsx(N,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-600",children:"Paiement non trouvé"}),e.jsx(T,{to:"/merchant/payments",className:"text-sky-600 hover:underline mt-2 inline-block",children:"Retour à la liste"})]})})}export{Ee as default};
