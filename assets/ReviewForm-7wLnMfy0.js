import{b as Q,u as Y,r as a,s as z,j as e}from"./index-BwkpV__w.js";import{S as D}from"./StarRating-aBqR_9Ag.js";import{C as F}from"./ClientLayout-CBiNTMcl.js";import{C as M}from"./check-fdtTgM-N.js";import{A as Z}from"./arrow-left-C0OczO8Y.js";import{S as $}from"./star--7Qkd0h3.js";import{V as ee}from"./video-BehHazyS.js";import{C as te}from"./circle-B65zwuTa.js";import{c as se}from"./createLucideIcon-Br99KG2k.js";import{X as re}from"./x-SOWQ9pA1.js";import{S as ae}from"./send-DII7O7Ka.js";import"./menu-SfYPTgzA.js";import"./scan-line-l6pT8TiG.js";import"./home-v7N_sL6K.js";import"./message-square-hiH7tUaC.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=se("StopCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{width:"6",height:"6",x:"9",y:"9",key:"1wrtvo"}]]);function we(){const[g]=Q(),p=Y(),T=g.get("code")||"",c=a.useRef(null),d=a.useRef(null),n=a.useRef(null),m=a.useRef([]),[r,o]=a.useState({clientName:"",clientPhone:"",rating:0,comment:""}),[j,v]=a.useState(!1),[N,w]=a.useState(!1),[l,y]=a.useState(!1),[u,x]=a.useState(0),[i,C]=a.useState(null),[R,S]=a.useState(null),[k,E]=a.useState(""),[P,h]=a.useState(""),[A,U]=a.useState(!1),[O,q]=a.useState(!1),[ne,I]=a.useState(!1),b=60;a.useEffect(()=>{const t=localStorage.getItem("lastClientPhone");t&&V(t)},[]),a.useEffect(()=>{let t;return l&&(t=setInterval(()=>{x(s=>s>=b?(f(),s):s+1)},1e3)),()=>clearInterval(t)},[l]);const V=async t=>{I(!0);try{const{data:s}=await z.from("exchanges").select("*").eq("client_phone",t).order("created_at",{ascending:!1}).limit(1);s&&s.length>0&&(o(K=>({...K,clientName:s[0].client_name||"",clientPhone:t})),q(!0))}catch(s){console.error(s)}finally{I(!1)}},B=t=>{o({...r,clientPhone:t}),t.length>=8&&V(t)},X=async()=>{try{E("");const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0});n.current=t,c.current&&(c.current.srcObject=t),w(!0)}catch{E("Impossible d'acceder a la camera")}},G=()=>{if(!n.current)return;m.current=[];const t=new MediaRecorder(n.current);t.ondataavailable=s=>{s.data.size>0&&m.current.push(s.data)},t.onstop=()=>{const s=new Blob(m.current,{type:"video/webm"});C(URL.createObjectURL(s)),S(s),L()},d.current=t,t.start(),y(!0),x(0)},f=()=>{var t,s;((t=d.current)==null?void 0:t.state)!=="inactive"&&((s=d.current)==null||s.stop()),y(!1)},L=()=>{var t;(t=n.current)==null||t.getTracks().forEach(s=>s.stop()),n.current=null,w(!1)},W=()=>{i&&URL.revokeObjectURL(i),C(null),S(null),x(0)},H=()=>{f(),L()},_=t=>Math.floor(t/60)+":"+(t%60).toString().padStart(2,"0"),J=async t=>{if(t.preventDefault(),r.rating===0){h("Veuillez selectionner une note");return}v(!0),h("");try{R&&console.log("[REVIEW] Video:",R.size,"bytes");const{error:s}=await z.from("reviews").insert({exchange_code:T||null,merchant_id:g.get("merchant")||null,client_name:r.clientName,client_phone:r.clientPhone,rating:r.rating,comment:r.comment||null,is_published:!0});if(s)throw s;localStorage.setItem("lastClientPhone",r.clientPhone),U(!0)}catch(s){h("Erreur: "+(s.message||"Reessayez"))}finally{v(!1)}};return A?e.jsx(F,{children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(M,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Merci pour votre avis !"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Votre retour nous aide a ameliorer nos services."}),e.jsx(D,{rating:r.rating,readonly:!0,size:"lg"}),e.jsx("button",{onClick:()=>p("/"),className:"mt-6 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium",children:"Retour"})]})})}):e.jsx(F,{children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>p(-1),className:"flex items-center text-slate-600 hover:text-slate-900 mb-6",children:[e.jsx(Z,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"Retour"})]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-full mb-4",children:e.jsx($,{className:"w-8 h-8 text-amber-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:"Laisser un avis"}),e.jsx("p",{className:"text-slate-600",children:"Partagez votre experience"})]}),O&&e.jsx("div",{className:"mb-6 bg-emerald-50 border border-emerald-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-emerald-700",children:[e.jsx(M,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Informations retrouvees"})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[P&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:P}),e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Vos informations"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Nom complet *"}),e.jsx("input",{type:"text",required:!0,value:r.clientName,onChange:t=>o({...r,clientName:t.target.value}),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Telephone *"}),e.jsx("input",{type:"tel",required:!0,value:r.clientPhone,onChange:t=>B(t.target.value),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Votre avis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-3",children:"Note *"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(D,{rating:r.rating,onRatingChange:t=>o({...r,rating:t}),size:"lg"}),r.rating>0&&e.jsxs("span",{className:"text-lg font-semibold text-amber-600",children:[r.rating,"/5"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Commentaire"}),e.jsx("textarea",{value:r.comment,onChange:t=>o({...r,comment:t.target.value}),rows:4,maxLength:500,className:"w-full px-4 py-3 border border-slate-300 rounded-lg resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Video (max 1 min)"}),!N&&!i&&e.jsxs("button",{type:"button",onClick:X,className:"w-full border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-amber-500 hover:bg-amber-50",children:[e.jsx(ee,{className:"w-10 h-10 text-slate-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-slate-600 font-medium",children:"Enregistrer une video"})]}),N&&e.jsxs("div",{className:"relative border border-slate-200 rounded-xl overflow-hidden bg-black",children:[e.jsx("video",{ref:c,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full min-h-[300px] object-cover"}),e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-black/70 rounded-full flex items-center gap-2",children:[l&&e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-2xl font-mono font-bold "+(l?"text-red-400":"text-white"),children:_(b-u)})]}),l&&e.jsx("div",{className:"absolute bottom-20 left-4 right-4",children:e.jsx("div",{className:"h-2 bg-white/30 rounded-full",children:e.jsx("div",{className:"h-full bg-red-500 rounded-full transition-all",style:{width:u/b*100+"%"}})})}),e.jsx("div",{className:"absolute bottom-4 left-0 right-0 flex justify-center gap-4",children:l?e.jsxs("button",{type:"button",onClick:f,className:"px-6 py-2 bg-red-600 text-white rounded-lg flex items-center gap-2 animate-pulse",children:[e.jsx(le,{className:"w-5 h-5"}),"Arreter"]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:H,className:"px-4 py-2 bg-slate-600 text-white rounded-lg",children:"Annuler"}),e.jsxs("button",{type:"button",onClick:G,className:"px-6 py-2 bg-red-500 text-white rounded-lg flex items-center gap-2",children:[e.jsx(te,{className:"w-5 h-5 fill-current"}),"Enregistrer"]})]})})]}),i&&e.jsxs("div",{className:"relative border border-slate-200 rounded-xl overflow-hidden bg-black",children:[e.jsx("video",{src:i,controls:!0,className:"w-full aspect-video"}),e.jsx("button",{type:"button",onClick:W,className:"absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full",children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx("div",{className:"absolute bottom-2 left-2 px-2 py-1 bg-black/70 text-white text-xs rounded",children:_(u)})]}),k&&e.jsx("p",{className:"text-sm text-red-600 mt-2",children:k})]})]})]}),e.jsx("button",{type:"submit",disabled:j||r.rating===0,className:"w-full flex items-center justify-center gap-2 py-4 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-300 text-white rounded-lg font-semibold",children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Envoi..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-5 h-5"}),"Envoyer"]})})]})]})]})})}export{we as default};
