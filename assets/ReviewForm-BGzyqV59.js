import{b as de,u as me,a as ue,c as xe,r as l,s as R,j as e}from"./index-CGuTpfce.js";import{L as he}from"./LanguageSwitcher-hB6ROlQ8.js";import{S as O}from"./StarRating--6iKqlCJ.js";import{C}from"./check-DlQsg9OQ.js";import{A as be}from"./arrow-left-BpEP3EcE.js";import{S as fe}from"./star-CkOw_Vnc.js";import{X as ge}from"./x-BDYXHXVZ.js";import{V as P}from"./video-B7Ox4wyp.js";import{S as pe}from"./square-Bd2lZXRp.js";import{S as je}from"./send-Cq53Vb81.js";import"./createLucideIcon-D9R5Vyj_.js";function _e(){const[E]=de(),k=me(),{t:ve,lang:t,dir:V}=ue(),{setClientInfo:G,addScannedMerchant:H,updateMerchantInteraction:J}=xe(),g=E.get("code")||"",d=E.get("merchant")||"",u=l.useRef(null),p=l.useRef(null),o=l.useRef(null),j=l.useRef([]),c=l.useRef(null),x=60,[i,K]=l.useState(null),[a,m]=l.useState({clientName:"",clientPhone:"",rating:0,comment:""}),[I,_]=l.useState(!1),[Q,z]=l.useState(!0),[Y,D]=l.useState(!1),[M,v]=l.useState(""),[Z,ee]=l.useState(!1),[se,te]=l.useState(!1),[N,L]=l.useState(!1),[h,w]=l.useState(!1),[b,f]=l.useState(0),[X,T]=l.useState(null),[A,q]=l.useState(null),[F,$]=l.useState("");l.useEffect(()=>{d?re():z(!1);const s=localStorage.getItem("lastClientPhone");s&&U(s)},[d]),l.useEffect(()=>{N&&u.current&&o.current&&(u.current.srcObject=o.current,u.current.play().catch(s=>{console.error("Error playing video:",s)}))},[N]);const re=async()=>{try{const{data:s,error:r}=await R.from("merchants").select("*").eq("id",d).single();!r&&s&&(K(s),H({id:s.id,name:s.store_name||s.name,logoUrl:s.logo_url}))}catch(s){console.error("Error loading merchant:",s)}finally{z(!1)}},U=async s=>{D(!0);try{const{data:r}=await R.from("exchanges").select("*").eq("client_phone",s).order("created_at",{ascending:!1}).limit(1);if(r&&r.length>0){const n=r[0];m(S=>({...S,clientName:n.client_name||"",clientPhone:s})),te(!0)}}catch(r){console.error("Error loading previous data:",r)}finally{D(!1)}},ae=async s=>{m({...a,clientPhone:s}),s.length>=8&&U(s)},le=async()=>{try{$("");const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0});o.current=s,L(!0)}catch(s){console.error("Error accessing camera:",s),$(t==="ar"?"ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§":"Impossible d'accÃ©der Ã  la camÃ©ra")}},B=()=>{c.current&&(clearInterval(c.current),c.current=null),o.current&&(o.current.getTracks().forEach(s=>s.stop()),o.current=null),L(!1),w(!1),f(0)},ne=()=>{if(!o.current)return;j.current=[];const s=new MediaRecorder(o.current,{mimeType:"video/webm"});s.ondataavailable=r=>{r.data.size>0&&j.current.push(r.data)},s.onstop=()=>{const r=new Blob(j.current,{type:"video/webm"}),n=new FileReader;n.onloadend=()=>{const S=n.result;T(S),q(r)},n.readAsDataURL(r),B()},p.current=s,s.start(),w(!0),f(0),c.current=setInterval(()=>{f(r=>{const n=r+1;return n>=x&&y(),n})},1e3)},y=()=>{c.current&&(clearInterval(c.current),c.current=null),p.current&&h&&(p.current.stop(),w(!1))},oe=()=>{T(null),q(null),f(0)},ce=()=>{y(),B()},W=s=>{const r=Math.floor(s/60),n=s%60;return`${r}:${n.toString().padStart(2,"0")}`},ie=async s=>{if(s.preventDefault(),a.rating===0){v(t==="ar"?"ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…":"Veuillez sÃ©lectionner une note");return}_(!0),v("");try{A&&console.log("[REVIEW] Video recorded:",A.size,"bytes");const{error:r}=await R.from("reviews").insert({exchange_code:g||null,merchant_id:d||null,client_name:a.clientName,client_phone:a.clientPhone,rating:a.rating,comment:a.comment||null,is_published:!0});if(r)throw r;localStorage.setItem("lastClientPhone",a.clientPhone),G(a.clientName,a.clientPhone),d&&J(d,"review"),ee(!0)}catch(r){console.error("Error submitting review:",r),v(t==="ar"?"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.":"Erreur lors de la soumission. Veuillez rÃ©essayer.")}finally{_(!1)}};return Q?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600"})}):Z?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4",dir:V,children:e.jsxs("div",{className:"max-w-md w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(C,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:t==="ar"?"Ø´ÙƒØ±Ù‹Ø§ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!":"Merci pour votre avis !"}),e.jsx("p",{className:"text-slate-600 mb-6",children:t==="ar"?"Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ØªØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø®Ø¯Ù…Ø§ØªÙ†Ø§.":"Votre retour nous aide Ã  amÃ©liorer nos services."}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsx(O,{rating:a.rating,readonly:!0,size:"lg"})}),e.jsx("button",{onClick:()=>k("/"),className:"px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",children:t==="ar"?"Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©":"Retour Ã  l'accueil"})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-slate-500 text-sm",children:["Powered by"," ",e.jsx("span",{className:"font-semibold text-emerald-400",children:"SWAPP"})]})})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",dir:V,children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"max-w-2xl mx-auto mb-4 flex justify-end",children:e.jsx(he,{})}),e.jsxs("button",{onClick:()=>k(-1),className:"flex items-center text-white/70 hover:text-white mb-6 transition-colors max-w-2xl mx-auto",children:[e.jsx(be,{className:`w-5 h-5 ${t==="ar"?"ml-2 rotate-180":"mr-2"}`}),e.jsx("span",{className:"font-medium",children:t==="ar"?"Ø§Ù„Ø¹ÙˆØ¯Ø©":"Retour"})]}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[i!=null&&i.logo_url?e.jsx("img",{src:i.logo_url,alt:i.store_name,className:"w-20 h-20 mx-auto rounded-2xl object-cover shadow-lg mb-4 border-2 border-white/20"}):e.jsx("div",{className:"w-20 h-20 mx-auto bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg mb-4",children:e.jsx(fe,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:t==="ar"?"Ø§ØªØ±Ùƒ ØªÙ‚ÙŠÙŠÙ…Ùƒ":"Laisser un avis"}),e.jsx("p",{className:"text-slate-300",children:t==="ar"?"Ø´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹Ù†Ø§":"Partagez votre expÃ©rience avec nous"}),i&&e.jsx("p",{className:"text-amber-400 font-medium mt-2",children:i.store_name})]}),se&&e.jsxs("div",{className:"mb-6 bg-emerald-500/20 border border-emerald-500/30 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-400",children:[e.jsx(C,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:t==="ar"?"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ":"Informations retrouvÃ©es"})]}),e.jsx("p",{className:"text-sm text-emerald-300 mt-1",children:t==="ar"?"ØªÙ… Ù…Ù„Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§":"Vos informations ont Ã©tÃ© remplies automatiquement"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6",children:[M&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:M}),e.jsxs("form",{onSubmit:ie,className:"space-y-6",children:[g&&e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 border border-slate-200",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t==="ar"?"Ø±Ù…Ø² Ø§Ù„ØªØ¨Ø§Ø¯Ù„":"Code d'Ã©change"}),e.jsx("input",{type:"text",value:g,disabled:!0,className:"w-full px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-900 font-mono font-semibold"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:t==="ar"?"Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ":"Vos informations"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[t==="ar"?"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„":"Nom complet"," *"]}),e.jsx("input",{type:"text",required:!0,value:a.clientName,onChange:s=>m({...a,clientName:s.target.value}),placeholder:t==="ar"?"Ø§Ø³Ù…Ùƒ":"Votre nom",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[t==="ar"?"Ø§Ù„Ù‡Ø§ØªÙ":"TÃ©lÃ©phone"," *"]}),e.jsx("input",{type:"tel",required:!0,value:a.clientPhone,onChange:s=>ae(s.target.value),placeholder:"+216 XX XXX XXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500",dir:"ltr"}),Y&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:t==="ar"?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ...":"Recherche de vos informations..."})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:t==="ar"?"ØªÙ‚ÙŠÙŠÙ…Ùƒ":"Votre avis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-3",children:[t==="ar"?"Ø§Ù„ØªÙ‚ÙŠÙŠÙ…":"Note"," *"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(O,{rating:a.rating,onRatingChange:s=>m({...a,rating:s}),size:"lg"}),a.rating>0&&e.jsxs("span",{className:"text-lg font-semibold text-amber-600",children:[a.rating,"/5"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t==="ar"?"ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)":"Commentaire (optionnel)"}),e.jsx("textarea",{value:a.comment,onChange:s=>m({...a,comment:s.target.value}),placeholder:t==="ar"?"ØµÙ ØªØ¬Ø±Ø¨ØªÙƒ...":"DÃ©crivez votre expÃ©rience...",rows:4,maxLength:500,className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 resize-none"}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1 text-right",children:[a.comment.length,"/500"," ",t==="ar"?"Ø­Ø±Ù":"caractÃ¨res"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t==="ar"?"ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)":"VidÃ©o (optionnel)"}),e.jsx("p",{className:"text-xs text-slate-600 mb-3",children:t==="ar"?"Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©":"DurÃ©e maximum 1 minute"}),e.jsxs("div",{className:"space-y-4",children:[N?e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:u,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-64 object-cover rounded-lg border border-slate-200 bg-black"}),h&&e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2 bg-red-600 text-white px-3 py-1.5 rounded-full shadow-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),e.jsxs("span",{className:"font-mono font-bold",children:[W(b)," /"," ",W(x)]})]}),h&&b>=50&&e.jsx("div",{className:"absolute top-3 right-3 bg-amber-500 text-white px-3 py-1.5 rounded-full text-sm shadow-lg",children:t==="ar"?`${x-b} Ø«Ø§Ù†ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©`:`${x-b}s restantes`}),e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4",children:h?e.jsxs("button",{type:"button",onClick:y,className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors shadow-lg animate-pulse",children:[e.jsx(pe,{className:"w-5 h-5"}),t==="ar"?"Ø¥ÙŠÙ‚Ø§Ù":"ArrÃªter"]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:ce,className:"flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-full hover:bg-slate-600 transition-colors shadow-lg",children:[e.jsx(ge,{className:"w-5 h-5"}),t==="ar"?"Ø¥Ù„ØºØ§Ø¡":"Annuler"]}),e.jsxs("button",{type:"button",onClick:ne,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg",children:[e.jsx(P,{className:"w-5 h-5"}),t==="ar"?"ØªØ³Ø¬ÙŠÙ„":"Enregistrer"]})]})})]}):X?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("video",{src:X,controls:!0,className:"w-full h-64 object-cover rounded-lg border border-slate-200"}),e.jsx("div",{className:"absolute top-2 right-2 flex gap-2",children:e.jsxs("button",{type:"button",onClick:oe,className:"flex items-center gap-1 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-lg text-sm",children:[e.jsx(P,{className:"w-4 h-4"}),t==="ar"?"Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„":"RÃ©-enregistrer"]})})]}),e.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-3 flex items-start gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-emerald-800",children:t==="ar"?"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!":"VidÃ©o enregistrÃ©e avec succÃ¨s !"}),e.jsx("p",{className:"text-xs text-emerald-600 mt-0.5",children:t==="ar"?"Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£ØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰":"Si vous avez fait une erreur, vous pouvez supprimer et rÃ©-enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{type:"button",onClick:le,className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:border-amber-500 transition-colors",children:[e.jsx(P,{className:"w-8 h-8 text-slate-400 mb-2"}),e.jsx("span",{className:"text-sm text-slate-500",children:t==="ar"?"Ø§Ù†Ù‚Ø± Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ":"Cliquez pour enregistrer"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium mb-1",children:t==="ar"?"ğŸ“¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:":"ğŸ“¹ Instructions d'enregistrement :"}),e.jsxs("ul",{className:"text-xs text-blue-700 space-y-1",children:[e.jsxs("li",{children:["â€¢"," ",t==="ar"?"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ³Ø¬ÙŠÙ„: Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© (60 Ø«Ø§Ù†ÙŠØ©)":"DurÃ©e maximale : 1 minute (60 secondes)"]}),e.jsxs("li",{children:["â€¢"," ",t==="ar"?"Ø´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ":"Partagez votre expÃ©rience en vidÃ©o"]}),e.jsxs("li",{children:["â€¢"," ",t==="ar"?"ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£Øª":"Vous pouvez rÃ©-enregistrer en cas d'erreur"]})]})]})]}),F&&e.jsx("p",{className:"text-sm text-red-600",children:F})]})]})]})]}),e.jsxs("button",{type:"submit",disabled:I||a.rating===0,className:"w-full flex items-center justify-center gap-2 py-4 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-colors shadow-lg",children:[e.jsx(je,{className:"w-5 h-5"}),I?t==="ar"?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...":"Envoi en cours...":t==="ar"?"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…":"Envoyer mon avis"]})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-slate-500 text-sm",children:["Powered by"," ",e.jsx("span",{className:"font-semibold text-emerald-400",children:"SWAPP"})]})})]})]})})}export{_e as default};
