import{s as P,j as e}from"./index-C-n_DeK3.js";import{f as W,u as A,r as a}from"./react-vendor-CTUriZ5h.js";import{S as R}from"./StarRating-cKOcZvBD.js";import{C as k}from"./ClientLayout-Myc20RW2.js";import{C as E}from"./check-Cm21nyZb.js";import{A as B}from"./arrow-left-CxjwE-xR.js";import{S as T}from"./star-Cw7sdsKF.js";import{V as G}from"./video-Cwp6uQ4V.js";import{X as H}from"./x-D4qrk5Qy.js";import{S as J}from"./send-DlqxrGT5.js";import"./supabase-Bl4YWSQ9.js";import"./menu-DP2azNEK.js";import"./createLucideIcon-CMjKDoEE.js";import"./scan-line-Dhzz-_Ia.js";import"./home-9mW_oZwz.js";import"./message-square-B53yKzw3.js";function me(){const[h]=W(),b=A(),m=h.get("code")||"",c=a.useRef(null),[s,i]=a.useState({clientName:"",clientPhone:"",rating:0,comment:""}),[f,p]=a.useState(!1),[d,g]=a.useState(null),[u,v]=a.useState(null),[L,j]=a.useState(0),[N,n]=a.useState(""),[U,w]=a.useState(!1),[z,y]=a.useState(!1),[S,x]=a.useState(""),[F,D]=a.useState(!1),[M,X]=a.useState(!1);a.useEffect(()=>{const t=localStorage.getItem("lastClientPhone");t&&V(t)},[]);const V=async t=>{y(!0);try{const{data:r}=await P.from("exchanges").select("*").eq("client_phone",t).order("created_at",{ascending:!1}).limit(1);if(r&&r.length>0){const o=r[0];i(l=>({...l,clientName:o.client_name||"",clientPhone:t})),X(!0)}}catch(r){console.error("Error loading previous data:",r)}finally{y(!1)}},_=async t=>{i({...s,clientPhone:t}),t.length>=8&&V(t)},I=t=>{var C;const r=(C=t.target.files)==null?void 0:C[0];if(!r)return;if(!r.type.startsWith("video/")){n("Veuillez selectionner un fichier video");return}if(r.size>50*1024*1024){n("La video ne doit pas depasser 50 MB");return}const o=URL.createObjectURL(r),l=document.createElement("video");l.preload="metadata",l.onloadedmetadata=()=>{if(l.duration>60){n("La video ne doit pas depasser 60 secondes (1 minute)"),URL.revokeObjectURL(o);return}n(""),g(r),v(o),j(Math.round(l.duration))},l.onerror=()=>{n("Impossible de lire ce fichier video"),URL.revokeObjectURL(o)},l.src=o},q=()=>{u&&URL.revokeObjectURL(u),g(null),v(null),j(0),n(""),c.current&&(c.current.value="")},O=async t=>{if(t.preventDefault(),s.rating===0){x("Veuillez sélectionner une note");return}p(!0),x("");try{let r=null;d&&(w(!0),console.log("[REVIEW] Video file to upload:",d.name,d.size,"bytes"),w(!1));const o=h.get("merchant")||"11111111-1111-1111-1111-111111111111",{error:l}=await P.from("reviews").insert({exchange_code:m||null,merchant_id:o,client_name:s.clientName,client_phone:s.clientPhone,rating:s.rating,comment:s.comment||null,video_url:r,is_published:!0});if(l)throw l;localStorage.setItem("lastClientPhone",s.clientPhone),D(!0)}catch(r){console.error("Error submitting review:",r),x("Erreur lors de la soumission. Veuillez réessayer.")}finally{p(!1)}};return F?e.jsx(k,{children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(E,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Merci pour votre avis !"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Votre retour nous aide a ameliorer nos services."}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsx(R,{rating:s.rating,readonly:!0,size:"lg"})}),e.jsx("button",{onClick:()=>b("/"),className:"px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",children:"Retour a l'accueil"})]})})}):e.jsx(k,{children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("button",{onClick:()=>b("/client/scan"),className:"flex items-center text-slate-600 hover:text-slate-900 mb-6 transition-colors",children:[e.jsx(B,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:"Retour"})]}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-amber-100 rounded-full mb-4",children:e.jsx(T,{className:"w-8 h-8 text-amber-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:"Laisser un avis"}),e.jsx("p",{className:"text-slate-600",children:"Partagez votre experience avec le marchand"})]}),M&&e.jsxs("div",{className:"mb-6 bg-emerald-50 border border-emerald-200 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-700",children:[e.jsx(E,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Informations retrouvees"})]}),e.jsx("p",{className:"text-sm text-emerald-600 mt-1",children:"Vos informations ont ete automatiquement remplies"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[S&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:S}),e.jsxs("form",{onSubmit:O,className:"space-y-6",children:[m&&e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 border border-slate-200",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Code d'echange"}),e.jsx("input",{type:"text",value:m,disabled:!0,className:"w-full px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-900 font-mono font-semibold"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Vos informations"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Nom complet *"}),e.jsx("input",{type:"text",required:!0,value:s.clientName,onChange:t=>i({...s,clientName:t.target.value}),placeholder:"Votre nom",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Telephone *"}),e.jsx("input",{type:"tel",required:!0,value:s.clientPhone,onChange:t=>_(t.target.value),placeholder:"+216 XX XXX XXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"}),z&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Recherche de vos informations..."})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:"Votre avis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-3",children:"Note *"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(R,{rating:s.rating,onRatingChange:t=>i({...s,rating:t}),size:"lg"}),s.rating>0&&e.jsxs("span",{className:"text-lg font-semibold text-amber-600",children:[s.rating,"/5"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Commentaire (optionnel)"}),e.jsx("textarea",{value:s.comment,onChange:t=>i({...s,comment:t.target.value}),placeholder:"Decrivez votre experience...",rows:4,maxLength:500,className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 resize-none"}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1 text-right",children:[s.comment.length,"/500 caracteres"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Video (optionnel - max 1 minute)"}),d?e.jsxs("div",{className:"relative border border-slate-200 rounded-xl overflow-hidden bg-black",children:[e.jsx("video",{src:u||void 0,controls:!0,className:"w-full max-h-64 object-contain"}),e.jsx("button",{type:"button",onClick:q,className:"absolute top-2 right-2 p-2 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors",children:e.jsx(H,{className:"w-4 h-4"})}),e.jsxs("div",{className:"absolute bottom-2 left-2 px-2 py-1 bg-black/70 text-white text-xs rounded",children:[L,"s"]})]}):e.jsxs("div",{onClick:()=>{var t;return(t=c.current)==null?void 0:t.click()},className:"border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-amber-500 hover:bg-amber-50 transition-colors",children:[e.jsx(G,{className:"w-10 h-10 text-slate-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-slate-600 font-medium",children:"Cliquez pour ajouter une video"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Format: MP4, MOV, WebM - Max 50 MB - Max 1 minute"}),e.jsx("input",{ref:c,type:"file",accept:"video/*",onChange:I,className:"hidden"})]}),N&&e.jsx("p",{className:"text-sm text-red-600 mt-2",children:N})]})]})]}),e.jsx("button",{type:"submit",disabled:f||s.rating===0,className:"w-full flex items-center justify-center gap-2 py-4 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition-colors shadow-sm",children:U?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Envoi de la video..."]}):f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Envoi en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-5 h-5"}),"Envoyer mon avis"]})})]})]})]})})}export{me as default};
