import{b as ce,u as de,a as me,c as ue,r as l,s as C,j as e}from"./index-DFvv-w89.js";import{L as xe}from"./LanguageSwitcher-B547mAGq.js";import{S as U}from"./StarRating-Bd1uAHfB.js";import{C as E}from"./check-CFmCtIJs.js";import{A as he}from"./arrow-left-npfwFTHV.js";import{S as be}from"./star-C0JDmjfi.js";import{X as ge}from"./x-Da1ibMTn.js";import{V as P}from"./video-BmMYZyy_.js";import{S as fe}from"./square-BWFc4CBW.js";import{S as pe}from"./send-DfbL6F-T.js";import"./createLucideIcon-uyDXa_zM.js";function _e(){const[V]=ce(),I=de(),{t:je,lang:s,dir:k}=me(),{setClientInfo:O,addScannedMerchant:G,updateMerchantInteraction:K}=ue(),j=V.get("code")||"",u=V.get("merchant")||"",h=l.useRef(null),v=l.useRef(null),i=l.useRef(null),N=l.useRef([]),c=l.useRef(null),b=60,[d,H]=l.useState(null),[a,x]=l.useState({clientName:"",clientPhone:"",rating:0,comment:""}),[_,D]=l.useState(!1),[J,M]=l.useState(!0),[Q,z]=l.useState(!1),[L,w]=l.useState(""),[Y,Z]=l.useState(!1),[ee,te]=l.useState(!1),[y,X]=l.useState(!1),[g,S]=l.useState(!1),[f,p]=l.useState(0),[o,T]=l.useState(null),[ve,A]=l.useState(null),[F,q]=l.useState("");l.useEffect(()=>{u?se():M(!1);const t=localStorage.getItem("lastClientPhone");t&&W(t)},[u]),l.useEffect(()=>{y&&h.current&&i.current&&(h.current.srcObject=i.current,h.current.play().catch(t=>{console.error("Error playing video:",t)}))},[y]);const se=async()=>{try{const{data:t,error:r}=await C.from("merchants").select("*").eq("id",u).single();!r&&t&&(H(t),G({id:t.id,name:t.store_name||t.name,logoUrl:t.logo_url}))}catch(t){console.error("Error loading merchant:",t)}finally{M(!1)}},W=async t=>{z(!0);try{const{data:r}=await C.from("exchanges").select("*").eq("client_phone",t).order("created_at",{ascending:!1}).limit(1);if(r&&r.length>0){const n=r[0];x(m=>({...m,clientName:n.client_name||"",clientPhone:t})),te(!0)}}catch(r){console.error("Error loading previous data:",r)}finally{z(!1)}},re=async t=>{x({...a,clientPhone:t}),t.length>=8&&W(t)},ae=async()=>{try{q("");const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0});i.current=t,X(!0)}catch(t){console.error("Error accessing camera:",t),q(s==="ar"?"ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§":"Impossible d'accÃ©der Ã  la camÃ©ra")}},$=()=>{c.current&&(clearInterval(c.current),c.current=null),i.current&&(i.current.getTracks().forEach(t=>t.stop()),i.current=null),X(!1),S(!1),p(0)},le=()=>{if(!i.current)return;N.current=[];const t=new MediaRecorder(i.current,{mimeType:"video/webm"});t.ondataavailable=r=>{r.data.size>0&&N.current.push(r.data)},t.onstop=()=>{const r=new Blob(N.current,{type:"video/webm"}),n=new FileReader;n.onloadend=()=>{const m=n.result;T(m),A(r)},n.readAsDataURL(r),$()},v.current=t,t.start(),S(!0),p(0),c.current=setInterval(()=>{p(r=>{const n=r+1;return n>=b&&R(),n})},1e3)},R=()=>{c.current&&(clearInterval(c.current),c.current=null),v.current&&g&&(v.current.stop(),S(!1))},ne=()=>{T(null),A(null),p(0)},oe=()=>{R(),$()},B=t=>{const r=Math.floor(t/60),n=t%60;return`${r}:${n.toString().padStart(2,"0")}`},ie=async t=>{if(t.preventDefault(),a.rating===0){w(s==="ar"?"ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…":"Veuillez sÃ©lectionner une note");return}D(!0),w("");try{console.log("[REVIEW] Submitting review with video:",o?`${(o.length/1024).toFixed(2)} KB`:"No video");const r={exchange_code:j||null,merchant_id:u||null,client_name:a.clientName,client_phone:a.clientPhone,rating:a.rating,comment:a.comment||null,is_published:!0};o&&o.length<5*1024*1024?(r.video_url=o,console.log("[REVIEW] Video added to review data")):o&&console.warn("[REVIEW] Video too large, skipping:",(o.length/1024/1024).toFixed(2),"MB");const{data:n,error:m}=await C.from("reviews").insert(r).select();if(console.log("[REVIEW] Insert result:",{data:n,error:m}),m)throw m;localStorage.setItem("lastClientPhone",a.clientPhone),O(a.clientName,a.clientPhone),u&&K(u,"review"),Z(!0)}catch(r){console.error("Error submitting review:",r),w(s==="ar"?"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.":"Erreur lors de la soumission. Veuillez rÃ©essayer.")}finally{D(!1)}};return J?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600"})}):Y?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4",dir:k,children:e.jsxs("div",{className:"max-w-md w-full",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(E,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:s==="ar"?"Ø´ÙƒØ±Ù‹Ø§ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!":"Merci pour votre avis !"}),e.jsx("p",{className:"text-slate-600 mb-6",children:s==="ar"?"Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ØªØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø®Ø¯Ù…Ø§ØªÙ†Ø§.":"Votre retour nous aide Ã  amÃ©liorer nos services."}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsx(U,{rating:a.rating,readonly:!0,size:"lg"})}),e.jsx("button",{onClick:()=>I("/"),className:"px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors",children:s==="ar"?"Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©":"Retour Ã  l'accueil"})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-slate-500 text-sm",children:["Powered by"," ",e.jsx("span",{className:"font-semibold text-emerald-400",children:"SWAPP"})]})})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",dir:k,children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"max-w-2xl mx-auto mb-4 flex justify-end",children:e.jsx(xe,{})}),e.jsxs("button",{onClick:()=>I(-1),className:"flex items-center text-white/70 hover:text-white mb-6 transition-colors max-w-2xl mx-auto",children:[e.jsx(he,{className:`w-5 h-5 ${s==="ar"?"ml-2 rotate-180":"mr-2"}`}),e.jsx("span",{className:"font-medium",children:s==="ar"?"Ø§Ù„Ø¹ÙˆØ¯Ø©":"Retour"})]}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[d!=null&&d.logo_url?e.jsx("img",{src:d.logo_url,alt:d.store_name,className:"w-20 h-20 mx-auto rounded-2xl object-cover shadow-lg mb-4 border-2 border-white/20"}):e.jsx("div",{className:"w-20 h-20 mx-auto bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg mb-4",children:e.jsx(be,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:s==="ar"?"Ø§ØªØ±Ùƒ ØªÙ‚ÙŠÙŠÙ…Ùƒ":"Laisser un avis"}),e.jsx("p",{className:"text-slate-300",children:s==="ar"?"Ø´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹Ù†Ø§":"Partagez votre expÃ©rience avec nous"}),d&&e.jsx("p",{className:"text-amber-400 font-medium mt-2",children:d.store_name})]}),ee&&e.jsxs("div",{className:"mb-6 bg-emerald-500/20 border border-emerald-500/30 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-400",children:[e.jsx(E,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:s==="ar"?"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ":"Informations retrouvÃ©es"})]}),e.jsx("p",{className:"text-sm text-emerald-300 mt-1",children:s==="ar"?"ØªÙ… Ù…Ù„Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§":"Vos informations ont Ã©tÃ© remplies automatiquement"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6",children:[L&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:L}),e.jsxs("form",{onSubmit:ie,className:"space-y-6",children:[j&&e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 border border-slate-200",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:s==="ar"?"Ø±Ù…Ø² Ø§Ù„ØªØ¨Ø§Ø¯Ù„":"Code d'Ã©change"}),e.jsx("input",{type:"text",value:j,disabled:!0,className:"w-full px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-900 font-mono font-semibold"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:s==="ar"?"Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ":"Vos informations"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[s==="ar"?"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„":"Nom complet"," *"]}),e.jsx("input",{type:"text",required:!0,value:a.clientName,onChange:t=>x({...a,clientName:t.target.value}),placeholder:s==="ar"?"Ø§Ø³Ù…Ùƒ":"Votre nom",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[s==="ar"?"Ø§Ù„Ù‡Ø§ØªÙ":"TÃ©lÃ©phone"," *"]}),e.jsx("input",{type:"tel",required:!0,value:a.clientPhone,onChange:t=>re(t.target.value),placeholder:"+216 XX XXX XXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500",dir:"ltr"}),Q&&e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:s==="ar"?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ...":"Recherche de vos informations..."})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-4",children:s==="ar"?"ØªÙ‚ÙŠÙŠÙ…Ùƒ":"Votre avis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-3",children:[s==="ar"?"Ø§Ù„ØªÙ‚ÙŠÙŠÙ…":"Note"," *"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(U,{rating:a.rating,onRatingChange:t=>x({...a,rating:t}),size:"lg"}),a.rating>0&&e.jsxs("span",{className:"text-lg font-semibold text-amber-600",children:[a.rating,"/5"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:s==="ar"?"ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)":"Commentaire (optionnel)"}),e.jsx("textarea",{value:a.comment,onChange:t=>x({...a,comment:t.target.value}),placeholder:s==="ar"?"ØµÙ ØªØ¬Ø±Ø¨ØªÙƒ...":"DÃ©crivez votre expÃ©rience...",rows:4,maxLength:500,className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 resize-none"}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1 text-right",children:[a.comment.length,"/500"," ",s==="ar"?"Ø­Ø±Ù":"caractÃ¨res"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:s==="ar"?"ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)":"VidÃ©o (optionnel)"}),e.jsx("p",{className:"text-xs text-slate-600 mb-3",children:s==="ar"?"Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©":"DurÃ©e maximum 1 minute"}),e.jsxs("div",{className:"space-y-4",children:[y?e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-64 object-cover rounded-lg border border-slate-200 bg-black"}),g&&e.jsxs("div",{className:"absolute top-3 left-3 flex items-center gap-2 bg-red-600 text-white px-3 py-1.5 rounded-full shadow-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),e.jsxs("span",{className:"font-mono font-bold",children:[B(f)," /"," ",B(b)]})]}),g&&f>=50&&e.jsx("div",{className:"absolute top-3 right-3 bg-amber-500 text-white px-3 py-1.5 rounded-full text-sm shadow-lg",children:s==="ar"?`${b-f} Ø«Ø§Ù†ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©`:`${b-f}s restantes`}),e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4",children:g?e.jsxs("button",{type:"button",onClick:R,className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors shadow-lg animate-pulse",children:[e.jsx(fe,{className:"w-5 h-5"}),s==="ar"?"Ø¥ÙŠÙ‚Ø§Ù":"ArrÃªter"]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:oe,className:"flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-full hover:bg-slate-600 transition-colors shadow-lg",children:[e.jsx(ge,{className:"w-5 h-5"}),s==="ar"?"Ø¥Ù„ØºØ§Ø¡":"Annuler"]}),e.jsxs("button",{type:"button",onClick:le,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg",children:[e.jsx(P,{className:"w-5 h-5"}),s==="ar"?"ØªØ³Ø¬ÙŠÙ„":"Enregistrer"]})]})})]}):o?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("video",{src:o,controls:!0,className:"w-full h-64 object-cover rounded-lg border border-slate-200"}),e.jsx("div",{className:"absolute top-2 right-2 flex gap-2",children:e.jsxs("button",{type:"button",onClick:ne,className:"flex items-center gap-1 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-lg text-sm",children:[e.jsx(P,{className:"w-4 h-4"}),s==="ar"?"Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„":"RÃ©-enregistrer"]})})]}),e.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-3 flex items-start gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-emerald-800",children:s==="ar"?"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!":"VidÃ©o enregistrÃ©e avec succÃ¨s !"}),e.jsx("p",{className:"text-xs text-emerald-600 mt-0.5",children:s==="ar"?"Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£ØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰":"Si vous avez fait une erreur, vous pouvez supprimer et rÃ©-enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{type:"button",onClick:ae,className:"flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:border-amber-500 transition-colors",children:[e.jsx(P,{className:"w-8 h-8 text-slate-400 mb-2"}),e.jsx("span",{className:"text-sm text-slate-500",children:s==="ar"?"Ø§Ù†Ù‚Ø± Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ":"Cliquez pour enregistrer"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium mb-1",children:s==="ar"?"ğŸ“¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:":"ğŸ“¹ Instructions d'enregistrement :"}),e.jsxs("ul",{className:"text-xs text-blue-700 space-y-1",children:[e.jsxs("li",{children:["â€¢"," ",s==="ar"?"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ³Ø¬ÙŠÙ„: Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© (60 Ø«Ø§Ù†ÙŠØ©)":"DurÃ©e maximale : 1 minute (60 secondes)"]}),e.jsxs("li",{children:["â€¢"," ",s==="ar"?"Ø´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ":"Partagez votre expÃ©rience en vidÃ©o"]}),e.jsxs("li",{children:["â€¢"," ",s==="ar"?"ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ Ø£Ø®Ø·Ø£Øª":"Vous pouvez rÃ©-enregistrer en cas d'erreur"]})]})]})]}),F&&e.jsx("p",{className:"text-sm text-red-600",children:F})]})]})]})]}),e.jsxs("button",{type:"submit",disabled:_||a.rating===0,className:"w-full flex items-center justify-center gap-2 py-4 bg-amber-500 hover:bg-amber-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-semibold transition-colors shadow-lg",children:[e.jsx(pe,{className:"w-5 h-5"}),_?s==="ar"?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...":"Envoi en cours...":s==="ar"?"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…":"Envoyer mon avis"]})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-slate-500 text-sm",children:["Powered by"," ",e.jsx("span",{className:"font-semibold text-emerald-400",children:"SWAPP"})]})})]})]})})}export{_e as default};
