import{u as O,r,s as m,j as e}from"./index-DFvv-w89.js";import{M as k}from"./MerchantLayout-DaYlHzKY.js";import{S as C}from"./StarRating-Bd1uAHfB.js";import{S as x}from"./star-C0JDmjfi.js";import{M as W}from"./message-square-CZQYz4Jq.js";import{S as G}from"./search-Ban9gG5a.js";import{U as H}from"./user-BSr19RbX.js";import{V as I}from"./video-BmMYZyy_.js";import{C as J}from"./check-CFmCtIJs.js";import{C as K,a as P}from"./chevron-up-Br_oroPC.js";import{S as Q}from"./send-DfbL6F-T.js";import"./x-Da1ibMTn.js";import"./createLucideIcon-uyDXa_zM.js";import"./menu-C3vAH9_j.js";import"./store-N3OyYKaz.js";import"./layout-dashboard-Cu2jKyVz.js";import"./package-DnO4fK3w.js";import"./truck-Bi_hIRN9.js";import"./users-BmwoClUy.js";import"./banknote-D7yUYJio.js";import"./log-out-Ba_KqF8c.js";function je(){const M=O(),[h,g]=r.useState([]),[D,j]=r.useState(!0),[d,E]=r.useState(""),[c,N]=r.useState(null),[u,p]=r.useState(null),[b,f]=r.useState({}),[v,y]=r.useState(null),[X,L]=r.useState(null),[i,w]=r.useState({total:0,averageRating:0,responseRate:0,ratingDistribution:[0,0,0,0,0]});r.useEffect(()=>{z()},[]);const z=async()=>{const{data:{session:s}}=await m.auth.getSession();if(!s){M("/merchant/login");return}let t=null;const{data:a}=await m.from("merchants").select("id").eq("user_id",s.user.id).maybeSingle();if(a)t=a;else{const{data:n}=await m.from("merchants").select("id").eq("email",s.user.email).maybeSingle();t=n}t?(L(t.id),T(t.id)):j(!1)},T=async s=>{try{const{data:t,error:a}=await m.from("reviews").select("*").eq("merchant_id",s).order("created_at",{ascending:!1});if(a)throw a;const n=t||[];g(n);const l=n.length,$=l>0?n.reduce((o,F)=>o+F.rating,0)/l:0,U=n.filter(o=>o.merchant_response).length,B=l>0?Math.round(U/l*100):0,_=[0,0,0,0,0];n.forEach(o=>{o.rating>=1&&o.rating<=5&&_[o.rating-1]++}),w({total:l,averageRating:Math.round($*10)/10,responseRate:B,ratingDistribution:_})}catch(t){console.error("Error fetching reviews:",t)}finally{j(!1)}},A=async s=>{const t=b[s];if(t!=null&&t.trim()){y(s);try{const{error:a}=await m.from("reviews").update({merchant_response:t.trim(),merchant_response_at:new Date().toISOString()}).eq("id",s);if(a)throw a;g(h.map(l=>l.id===s?{...l,merchant_response:t.trim(),merchant_response_at:new Date().toISOString()}:l)),f(l=>({...l,[s]:""})),p(null);const n=h.filter(l=>l.merchant_response||l.id===s).length;w(l=>({...l,responseRate:Math.round(n/l.total*100)}))}catch(a){console.error("Error submitting response:",a)}finally{y(null)}}},R=h.filter(s=>{var n;const t=s.client_name.toLowerCase().includes(d.toLowerCase())||s.client_phone.includes(d)||((n=s.comment)==null?void 0:n.toLowerCase().includes(d.toLowerCase())),a=c===null||s.rating===c;return t&&a}),S=s=>new Date(s).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"}),q=s=>s>=4?"text-emerald-600 bg-emerald-50":s>=3?"text-amber-600 bg-amber-50":"text-red-600 bg-red-50",V=s=>["Très mauvais","Mauvais","Moyen","Bon","Excellent"][s-1]||"";return D?e.jsx(k,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600"})})}):e.jsx(k,{children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Avis Clients"}),e.jsx("p",{className:"text-slate-600",children:"Consultez et répondez aux avis de vos clients"})]}),e.jsxs("div",{className:"grid md:grid-cols-4 gap-6 mb-8",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl font-bold text-slate-900 mb-2",children:i.averageRating}),e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx(C,{rating:Math.round(i.averageRating),readonly:!0,size:"sm"})}),e.jsx("p",{className:"text-sm text-slate-500",children:"Note moyenne"})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"p-2 bg-amber-100 rounded-lg",children:e.jsx(x,{className:"w-5 h-5 text-amber-600"})})}),e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:i.total}),e.jsx("p",{className:"text-sm text-slate-500",children:"Total des avis"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"p-2 bg-sky-100 rounded-lg",children:e.jsx(W,{className:"w-5 h-5 text-sky-600"})})}),e.jsxs("div",{className:"text-2xl font-bold text-slate-900",children:[i.responseRate,"%"]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Taux de réponse"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h4",{className:"text-sm font-medium text-slate-700 mb-3",children:"Distribution"}),e.jsx("div",{className:"space-y-2",children:[5,4,3,2,1].map(s=>{const t=i.ratingDistribution[s-1],a=i.total>0?t/i.total*100:0;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-slate-600 w-3",children:s}),e.jsx(x,{className:"w-3 h-3 text-amber-400 fill-amber-400"}),e.jsx("div",{className:"flex-1 h-2 bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-400 rounded-full transition-all",style:{width:`${a}%`}})}),e.jsx("span",{className:"text-xs text-slate-500 w-6",children:t})]},s)})})]})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(G,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par nom, téléphone ou commentaire...",value:d,onChange:s=>E(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>N(null),className:`px-4 py-2 rounded-lg font-medium transition-colors ${c===null?"bg-sky-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:"Tous"}),[5,4,3,2,1].map(s=>e.jsxs("button",{onClick:()=>N(s),className:`flex items-center gap-1 px-3 py-2 rounded-lg font-medium transition-colors ${c===s?"bg-sky-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:[s,e.jsx(x,{className:`w-4 h-4 ${c===s?"fill-white":"fill-amber-400 text-amber-400"}`})]},s))]})]})}),R.length===0?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(x,{className:"w-8 h-8 text-slate-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Aucun avis"}),e.jsx("p",{className:"text-slate-600",children:d||c!==null?"Aucun avis ne correspond à vos critères":"Vous n'avez pas encore reçu d'avis clients"})]}):e.jsx("div",{className:"space-y-4",children:R.map(s=>{var t;return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden",children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center",children:e.jsx(H,{className:"w-6 h-6 text-slate-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:s.client_name}),e.jsx("p",{className:"text-sm text-slate-500",children:s.client_phone})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:`inline-flex items-center gap-2 px-3 py-1 rounded-full ${q(s.rating)}`,children:[e.jsx("span",{className:"font-semibold",children:s.rating}),e.jsx(x,{className:"w-4 h-4 fill-current"}),e.jsx("span",{className:"text-sm",children:V(s.rating)})]}),e.jsx("p",{className:"text-sm text-slate-500 mt-1",children:S(s.created_at)})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(C,{rating:s.rating,readonly:!0,size:"md"})}),s.comment&&e.jsx("div",{className:"bg-slate-50 rounded-lg p-4 mb-4",children:e.jsx("p",{className:"text-slate-700 leading-relaxed",children:s.comment})}),s.video_url&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(I,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium text-slate-700",children:"Vidéo du client"})]}),e.jsx("video",{src:s.video_url,controls:!0,className:"w-full max-w-md h-48 object-cover rounded-lg border border-slate-200"})]}),s.exchange_code&&e.jsxs("p",{className:"text-sm text-slate-500",children:["Code d'échange:"," ",e.jsx("span",{className:"font-mono font-medium text-slate-700",children:s.exchange_code})]}),s.merchant_response&&e.jsxs("div",{className:"mt-4 bg-sky-50 border border-sky-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(J,{className:"w-4 h-4 text-sky-600"}),e.jsx("span",{className:"text-sm font-medium text-sky-800",children:"Votre réponse"}),s.merchant_response_at&&e.jsxs("span",{className:"text-xs text-sky-600",children:["• ",S(s.merchant_response_at)]})]}),e.jsx("p",{className:"text-slate-700",children:s.merchant_response})]})]}),!s.merchant_response&&e.jsxs("div",{className:"border-t border-slate-200",children:[e.jsxs("button",{onClick:()=>p(u===s.id?null:s.id),className:"w-full px-6 py-3 flex items-center justify-between text-sky-600 hover:bg-sky-50 transition-colors",children:[e.jsx("span",{className:"font-medium",children:"Répondre à cet avis"}),u===s.id?e.jsx(K,{className:"w-5 h-5"}):e.jsx(P,{className:"w-5 h-5"})]}),u===s.id&&e.jsxs("div",{className:"px-6 pb-6",children:[e.jsx("textarea",{value:b[s.id]||"",onChange:a=>f(n=>({...n,[s.id]:a.target.value})),placeholder:"Écrivez votre réponse...",rows:3,className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 resize-none mb-3"}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{p(null),f(a=>({...a,[s.id]:""}))},className:"px-4 py-2 text-slate-600 hover:text-slate-800 transition-colors",children:"Annuler"}),e.jsxs("button",{onClick:()=>A(s.id),disabled:!((t=b[s.id])!=null&&t.trim())||v===s.id,className:"flex items-center gap-2 px-6 py-2 bg-sky-600 hover:bg-sky-700 disabled:bg-slate-300 text-white rounded-lg transition-colors",children:[e.jsx(Q,{className:"w-4 h-4"}),v===s.id?"Envoi...":"Envoyer"]})]})]})]})]},s.id)})})]})})}export{je as default};
