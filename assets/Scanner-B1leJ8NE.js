import{u as U,s as i,j as e}from"./index-BVTsSg9O.js";import{r as c,u as z}from"./react-vendor-CTUriZ5h.js";import{H as I}from"./qr-scanner-QRjSEYwL.js";import{L as B}from"./LanguageSwitcher-PVOD44pX.js";import{S as W}from"./scan-line-Dhzz-_Ia.js";import{K as A}from"./key-round-jTceDe-V.js";import{X as H}from"./x-D4qrk5Qy.js";import{P as K}from"./package-ChDCFdB3.js";import{S as J}from"./star-Cw7sdsKF.js";import"./supabase-Bl4YWSQ9.js";import"./createLucideIcon-CMjKDoEE.js";function re(){const[v,f]=c.useState(""),[b,k]=c.useState(""),[p,w]=c.useState(!1),[j,N]=c.useState(!1),[q,x]=c.useState(!1),[u,R]=c.useState(""),[g,E]=c.useState(null),n=z(),{t:d,dir:X,lang:l}=U();c.useEffect(()=>{if(!p){const a=new I("qr-reader",{fps:10,qrbox:{width:250,height:250}},!1);return a.render(L,P),()=>{a.clear()}}},[p]);const L=a=>{y(a)},P=()=>{},M=()=>{x(!1),g?n("/client/exchange/new?merchant="+g):u&&n("/client/exchange/new?code="+u)},Q=()=>{x(!1);const a=new URLSearchParams;u&&a.set("code",u),g&&a.set("merchant",g),n("/client/review/new?"+a.toString())},y=async a=>{N(!0),f("");try{if(a.includes("/client/exchange/new?bordereau=")){let t=null;try{t=new URL(a).searchParams.get("bordereau")}catch{const r=a.match(/bordereau=([^&]+)/);r&&(t=r[1])}if(t){const{data:r}=await i.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",t).maybeSingle();if(r&&r.status!=="available"&&r.exchange_id){const{data:_}=await i.from("exchanges").select("exchange_code").eq("id",r.exchange_id).single();if(_){n(`/client/tracking/${_.exchange_code}`);return}}const{data:h}=await i.from("exchanges").select("exchange_code").eq("bordereau_code",t).maybeSingle();if(h){n(`/client/tracking/${h.exchange_code}`);return}n(`/client/exchange/new?bordereau=${t}`);return}}if(a.includes("/client/exchange/new?merchant=")){const r=new URL(a).searchParams.get("merchant");if(r){n(`/client/exchange/new?merchant=${r}`);return}}if(a.includes("/client/tracking/")){const r=new URL(a).pathname.split("/"),h=r[r.length-1];if(h){n(`/client/tracking/${h}`);return}}let o=null,s=null;try{const t=JSON.parse(a);o=t.merchant_id,s=t.code}catch{s=a}if(s&&s.startsWith("EXC-")){const{data:t}=await i.from("exchanges").select("exchange_code").eq("exchange_code",s).maybeSingle();if(t){n(`/client/tracking/${t.exchange_code}`);return}}if(s&&s.startsWith("BDX-")){const{data:t}=await i.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",s).maybeSingle();if(t&&t.status!=="available"&&t.exchange_id){const{data:r}=await i.from("exchanges").select("exchange_code").eq("id",t.exchange_id).single();if(r){n(`/client/tracking/${r.exchange_code}`);return}}n(`/client/exchange/new?bordereau=${s}`);return}let m=i.from("merchants").select("*");o?m=m.eq("id",o):s&&(m=m.eq("qr_code_data",s));const{data:S,error:C}=await m.maybeSingle();if(C)throw C;S?(E(S.id),R(s||""),x(!0)):f(d("invalidQRCode"))}catch(o){console.error("Error validating QR code:",o),f(d("invalidQRCode"))}finally{N(!1)}},$=a=>{a.preventDefault(),b.trim()&&y(b.trim())};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-sky-50",dir:X,children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"flex justify-end mb-6",children:e.jsx(B,{})}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(W,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:d("scanQRCode")}),e.jsx("p",{className:"text-slate-600",children:d("scanDescription")})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[v&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:v}),j&&e.jsxs("div",{className:"mb-4 p-4 bg-sky-50 border border-sky-200 rounded-lg text-sky-700 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-sky-600"}),d("loading")]}),p?e.jsxs("form",{onSubmit:$,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:l==="ar"?"رمز التاجر":"Code du commerçant"}),e.jsx("input",{type:"text",value:b,onChange:a=>k(a.target.value),placeholder:"SWAPP-XXXXXXXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",dir:"ltr"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:j,className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300 text-white rounded-lg font-medium transition-colors",children:j?d("loading"):l==="ar"?"التحقق من الرمز":"Valider le code"}),e.jsx("button",{type:"button",onClick:()=>w(!1),className:"w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:l==="ar"?"العودة للماسح":"Retour au scanner"})]})]}):e.jsxs("div",{children:[e.jsx("div",{id:"qr-reader",className:"mb-4"}),e.jsxs("button",{onClick:()=>w(!0),className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(A,{className:"w-5 h-5"}),l==="ar"?"إدخال الرمز يدوياً":"Entrer le code manuellement"]})]}),e.jsx("div",{className:"mt-6 p-4 bg-emerald-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-emerald-800",children:l==="ar"?"امسح رمز QR المقدم من التاجر لتقديم طلب تبديل المنتج.":"Scannez le QR code fourni par votre commerçant pour soumettre une demande d'échange de produit."})})]})]})]}),q&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:l==="ar"?"ماذا تريد أن تفعل؟":"Que souhaitez-vous faire ?"}),e.jsx("button",{onClick:()=>x(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors",children:e.jsx(H,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("button",{onClick:M,className:"flex items-center gap-4 p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl hover:border-emerald-500 hover:bg-emerald-100 transition-all text-left",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center",children:e.jsx(K,{className:"w-6 h-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:l==="ar"?"طلب استبدال":"Demander un echange"}),e.jsx("p",{className:"text-sm text-slate-600",children:l==="ar"?"استبدال منتجك بآخر":"Echanger votre produit"})]})]}),e.jsxs("button",{onClick:Q,className:"flex items-center gap-4 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl hover:border-amber-500 hover:bg-amber-100 transition-all text-left",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center",children:e.jsx(J,{className:"w-6 h-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:l==="ar"?"ترك تقييم":"Laisser un avis"}),e.jsx("p",{className:"text-sm text-slate-600",children:l==="ar"?"شارك تجربتك":"Partagez votre experience"})]})]})]})]})})})]})}export{re as default};
