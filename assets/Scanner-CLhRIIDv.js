import{u as X,s as i,j as e}from"./index-hp3Tfpax.js";import{r as c,u as L}from"./react-vendor-CTUriZ5h.js";import{H as $}from"./qr-scanner-QRjSEYwL.js";import{L as M}from"./LanguageSwitcher-BaikrBsx.js";import{S as P}from"./scan-line-Dhzz-_Ia.js";import{K as Q}from"./key-round-jTceDe-V.js";import{X as z}from"./x-D4qrk5Qy.js";import{P as I}from"./package-ChDCFdB3.js";import{S as U}from"./star-Cw7sdsKF.js";import"./supabase-Bl4YWSQ9.js";import"./createLucideIcon-CMjKDoEE.js";function ae(){const[f,u]=c.useState(""),[x,S]=c.useState(""),[g,p]=c.useState(!1),[b,j]=c.useState(!1),[C,_]=c.useState(!1),[B,W]=c.useState(""),[A,H]=c.useState(null),l=L(),{t:d,dir:k,lang:n}=X();c.useEffect(()=>{if(!g){const r=new $("qr-reader",{fps:10,qrbox:{width:250,height:250}},!1);return r.render(q,R),()=>{r.clear()}}},[g]);const q=r=>{v(r)},R=()=>{},v=async r=>{j(!0),u("");try{if(r.includes("/client/exchange/new?bordereau=")){let a=null;try{a=new URL(r).searchParams.get("bordereau")}catch{const t=r.match(/bordereau=([^&]+)/);t&&(a=t[1])}if(a){const{data:t}=await i.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",a).maybeSingle();if(t&&t.status!=="available"&&t.exchange_id){const{data:y}=await i.from("exchanges").select("exchange_code").eq("id",t.exchange_id).single();if(y){l(`/client/tracking/${y.exchange_code}`);return}}const{data:h}=await i.from("exchanges").select("exchange_code").eq("bordereau_code",a).maybeSingle();if(h){l(`/client/tracking/${h.exchange_code}`);return}l(`/client/exchange/new?bordereau=${a}`);return}}if(r.includes("/client/exchange/new?merchant=")){const t=new URL(r).searchParams.get("merchant");if(t){l(`/client/exchange/new?merchant=${t}`);return}}if(r.includes("/client/tracking/")){const t=new URL(r).pathname.split("/"),h=t[t.length-1];if(h){l(`/client/tracking/${h}`);return}}let o=null,s=null;try{const a=JSON.parse(r);o=a.merchant_id,s=a.code}catch{s=r}if(s&&s.startsWith("EXC-")){const{data:a}=await i.from("exchanges").select("exchange_code").eq("exchange_code",s).maybeSingle();if(a){l(`/client/tracking/${a.exchange_code}`);return}}if(s&&s.startsWith("BDX-")){const{data:a}=await i.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",s).maybeSingle();if(a&&a.status!=="available"&&a.exchange_id){const{data:t}=await i.from("exchanges").select("exchange_code").eq("id",a.exchange_id).single();if(t){l(`/client/tracking/${t.exchange_code}`);return}}l(`/client/exchange/new?bordereau=${s}`);return}let m=i.from("merchants").select("*");o?m=m.eq("id",o):s&&(m=m.eq("qr_code_data",s));const{data:w,error:N}=await m.maybeSingle();if(N)throw N;w?l(`/client/exchange/new?merchant=${w.id}`):u(d("invalidQRCode"))}catch(o){console.error("Error validating QR code:",o),u(d("invalidQRCode"))}finally{j(!1)}},E=r=>{r.preventDefault(),x.trim()&&v(x.trim())};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-sky-50",dir:k,children:[e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"flex justify-end mb-6",children:e.jsx(M,{})}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(P,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:d("scanQRCode")}),e.jsx("p",{className:"text-slate-600",children:d("scanDescription")})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[f&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:f}),b&&e.jsxs("div",{className:"mb-4 p-4 bg-sky-50 border border-sky-200 rounded-lg text-sky-700 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-sky-600"}),d("loading")]}),g?e.jsxs("form",{onSubmit:E,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:n==="ar"?"رمز التاجر":"Code du commerçant"}),e.jsx("input",{type:"text",value:x,onChange:r=>S(r.target.value),placeholder:"SWAPP-XXXXXXXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",dir:"ltr"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:b,className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300 text-white rounded-lg font-medium transition-colors",children:b?d("loading"):n==="ar"?"التحقق من الرمز":"Valider le code"}),e.jsx("button",{type:"button",onClick:()=>p(!1),className:"w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:n==="ar"?"العودة للماسح":"Retour au scanner"})]})]}):e.jsxs("div",{children:[e.jsx("div",{id:"qr-reader",className:"mb-4"}),e.jsxs("button",{onClick:()=>p(!0),className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(Q,{className:"w-5 h-5"}),n==="ar"?"إدخال الرمز يدوياً":"Entrer le code manuellement"]})]}),e.jsx("div",{className:"mt-6 p-4 bg-emerald-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-emerald-800",children:n==="ar"?"امسح رمز QR المقدم من التاجر لتقديم طلب تبديل المنتج.":"Scannez le QR code fourni par votre commerçant pour soumettre une demande d'échange de produit."})})]})]})]}),C&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:n==="ar"?"ماذا تريد أن تفعل؟":"Que souhaitez-vous faire ?"}),e.jsx("button",{onClick:()=>_(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors",children:e.jsx(z,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("button",{onClick:handleChoiceExchange,className:"flex items-center gap-4 p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl hover:border-emerald-500 hover:bg-emerald-100 transition-all text-left",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center",children:e.jsx(I,{className:"w-6 h-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:n==="ar"?"طلب استبدال":"Demander un échange"}),e.jsx("p",{className:"text-sm text-slate-600",children:n==="ar"?"استبدال منتجك بآخر":"Échanger votre produit contre un autre"})]})]}),e.jsxs("button",{onClick:handleChoiceReview,className:"flex items-center gap-4 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl hover:border-amber-500 hover:bg-amber-100 transition-all text-left",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center",children:e.jsx(U,{className:"w-6 h-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:n==="ar"?"ترك تقييم":"Laisser un avis"}),e.jsx("p",{className:"text-sm text-slate-600",children:n==="ar"?"شارك تجربتك مع التاجر":"Partagez votre expérience avec le marchand"})]})]})]})]})})})]})}export{ae as default};
