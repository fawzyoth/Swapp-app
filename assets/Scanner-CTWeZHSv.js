import{u as R,s as c,j as e}from"./index-DGuJxBT7.js";import{r as u,u as E}from"./react-vendor-CTUriZ5h.js";import{H as X}from"./qr-scanner-QRjSEYwL.js";import{L as $}from"./LanguageSwitcher-Cs6tBaXM.js";import{S as L}from"./scan-line-Dhzz-_Ia.js";import{K as Q}from"./key-round-jTceDe-V.js";import"./supabase-Bl4YWSQ9.js";import"./createLucideIcon-CMjKDoEE.js";function K(){const[b,h]=u.useState(""),[x,_]=u.useState(""),[g,p]=u.useState(!1),[f,j]=u.useState(!1),s=E(),{t:l,dir:S,lang:i}=R();u.useEffect(()=>{if(!g){const r=new X("qr-reader",{fps:10,qrbox:{width:250,height:250}},!1);return r.render(k,q),()=>{r.clear()}}},[g]);const k=r=>{w(r)},q=()=>{},w=async r=>{j(!0),h("");try{if(r.includes("/client/exchange/new?bordereau=")){let a=null;try{a=new URL(r).searchParams.get("bordereau")}catch{const t=r.match(/bordereau=([^&]+)/);t&&(a=t[1])}if(a){const{data:t}=await c.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",a).maybeSingle();if(t&&t.status!=="available"&&t.exchange_id){const{data:N}=await c.from("exchanges").select("exchange_code").eq("id",t.exchange_id).single();if(N){s(`/client/tracking/${N.exchange_code}`);return}}const{data:m}=await c.from("exchanges").select("exchange_code").eq("bordereau_code",a).maybeSingle();if(m){s(`/client/tracking/${m.exchange_code}`);return}s(`/client/exchange/new?bordereau=${a}`);return}}if(r.includes("/client/exchange/new?merchant=")){const t=new URL(r).searchParams.get("merchant");if(t){s(`/client/exchange/new?merchant=${t}`);return}}if(r.includes("/client/tracking/")){const t=new URL(r).pathname.split("/"),m=t[t.length-1];if(m){s(`/client/tracking/${m}`);return}}let o=null,n=null;try{const a=JSON.parse(r);o=a.merchant_id,n=a.code}catch{n=r}if(n&&n.startsWith("EXC-")){const{data:a}=await c.from("exchanges").select("exchange_code").eq("exchange_code",n).maybeSingle();if(a){s(`/client/tracking/${a.exchange_code}`);return}}if(n&&n.startsWith("BDX-")){const{data:a}=await c.from("merchant_bordereaux").select("status, exchange_id").eq("bordereau_code",n).maybeSingle();if(a&&a.status!=="available"&&a.exchange_id){const{data:t}=await c.from("exchanges").select("exchange_code").eq("id",a.exchange_id).single();if(t){s(`/client/tracking/${t.exchange_code}`);return}}s(`/client/exchange/new?bordereau=${n}`);return}let d=c.from("merchants").select("*");o?d=d.eq("id",o):n&&(d=d.eq("qr_code_data",n));const{data:y,error:v}=await d.maybeSingle();if(v)throw v;y?s(`/client/exchange/new?merchant=${y.id}`):h(l("invalidQRCode"))}catch(o){console.error("Error validating QR code:",o),h(l("invalidQRCode"))}finally{j(!1)}},C=r=>{r.preventDefault(),x.trim()&&w(x.trim())};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-sky-50",dir:S,children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("div",{className:"flex justify-end mb-6",children:e.jsx($,{})}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full mb-4",children:e.jsx(L,{className:"w-8 h-8 text-emerald-600"})}),e.jsx("h1",{className:"text-3xl font-bold text-slate-900 mb-2",children:l("scanQRCode")}),e.jsx("p",{className:"text-slate-600",children:l("scanDescription")})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6",children:[b&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700",children:b}),f&&e.jsxs("div",{className:"mb-4 p-4 bg-sky-50 border border-sky-200 rounded-lg text-sky-700 flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-sky-600"}),l("loading")]}),g?e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:i==="ar"?"رمز التاجر":"Code du commerçant"}),e.jsx("input",{type:"text",value:x,onChange:r=>_(r.target.value),placeholder:"SWAPP-XXXXXXXX",className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",dir:"ltr"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"submit",disabled:f,className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300 text-white rounded-lg font-medium transition-colors",children:f?l("loading"):i==="ar"?"التحقق من الرمز":"Valider le code"}),e.jsx("button",{type:"button",onClick:()=>p(!1),className:"w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:i==="ar"?"العودة للماسح":"Retour au scanner"})]})]}):e.jsxs("div",{children:[e.jsx("div",{id:"qr-reader",className:"mb-4"}),e.jsxs("button",{onClick:()=>p(!0),className:"w-full flex items-center justify-center gap-2 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors",children:[e.jsx(Q,{className:"w-5 h-5"}),i==="ar"?"إدخال الرمز يدوياً":"Entrer le code manuellement"]})]}),e.jsx("div",{className:"mt-6 p-4 bg-emerald-50 rounded-lg",children:e.jsx("p",{className:"text-sm text-emerald-800",children:i==="ar"?"امسح رمز QR المقدم من التاجر لتقديم طلب تبديل المنتج.":"Scannez le QR code fourni par votre commerçant pour soumettre une demande d'échange de produit."})})]})]})]})})}export{K as default};
