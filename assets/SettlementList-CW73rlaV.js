import{s as o,j as e}from"./index-DdAZvCql.js";import{r}from"./react-vendor-CTUriZ5h.js";import{A as _}from"./AdminLayout-B-xDB4Cc.js";import{A as M}from"./alert-circle-_Iqic_ih.js";import{F as T}from"./filter-Cp7rfch8.js";import{U as z}from"./user-DEx4Ce9L.js";import{C as B}from"./calendar-upMk3ayk.js";import{B as U}from"./banknote-JI0QWWz-.js";import{C}from"./check-circle-CyNeZd0p.js";import{X as S}from"./x-circle-D3f66Y07.js";import{C as V}from"./clock-Dhxn45-3.js";import"./supabase-Bl4YWSQ9.js";import"./x-D4qrk5Qy.js";import"./createLucideIcon-CMjKDoEE.js";import"./menu-DP2azNEK.js";import"./shield-BNgLrtrc.js";import"./layout-dashboard-CqNl1jWq.js";import"./users-4zMWxYqH.js";import"./truck-CgEV9F53.js";import"./wallet-CVOcG8S4.js";import"./store-B-5iV_wL.js";import"./file-text-B3Ewreww.js";import"./home-9mW_oZwz.js";function ce(){var y,w;const[k,D]=r.useState(!0),[p,R]=r.useState([]),[i,g]=r.useState("pending"),[E,u]=r.useState(!1),[A,h]=r.useState(!1),[t,l]=r.useState(null),[N,f]=r.useState(""),[c,j]=r.useState(""),[n,m]=r.useState(!1);r.useEffect(()=>{b()},[i]);const b=async()=>{try{let s=o.from("delivery_person_settlements").select(`
          *,
          delivery_person:delivery_person_id (
            name,
            email,
            phone
          )
        `).order("created_at",{ascending:!1});i!=="all"&&(s=s.eq("status",i));const{data:a,error:d}=await s;if(d)throw d;R((a==null?void 0:a.map(x=>({...x,delivery_person:Array.isArray(x.delivery_person)?x.delivery_person[0]:x.delivery_person})))||[])}catch(s){console.error("Error fetching settlements:",s)}finally{D(!1)}},F=async()=>{if(t){m(!0);try{const{data:{user:s}}=await o.auth.getUser(),{error:a}=await o.from("delivery_person_settlements").update({status:"confirmed",confirmed_by:s==null?void 0:s.id,confirmed_at:new Date().toISOString(),confirmation_notes:N||null}).eq("id",t.id);if(a)throw a;await o.from("financial_transactions").insert({settlement_id:t.id,delivery_person_id:t.delivery_person_id,transaction_type:"settlement_to_partner",amount:t.amount,currency:"TND",direction:"debit",status:"completed",description:`Règlement confirmé - ${t.exchanges_count} échanges`}),u(!1),l(null),f(""),b(),alert("Règlement confirmé avec succès")}catch(s){console.error("Error confirming settlement:",s),alert("Erreur lors de la confirmation")}finally{m(!1)}}},L=async()=>{if(!t||!c.trim()){alert("Veuillez fournir une raison");return}m(!0);try{const{error:s}=await o.from("delivery_person_settlements").update({status:"disputed",confirmation_notes:c}).eq("id",t.id);if(s)throw s;h(!1),l(null),j(""),b(),alert("Règlement contesté")}catch(s){console.error("Error disputing settlement:",s),alert("Erreur lors de la contestation")}finally{m(!1)}},q=s=>{switch(s){case"confirmed":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium",children:[e.jsx(C,{className:"w-3 h-3"}),"Confirmé"]});case"pending":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium",children:[e.jsx(V,{className:"w-3 h-3"}),"En attente"]});case"disputed":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium",children:[e.jsx(S,{className:"w-3 h-3"}),"Contesté"]});default:return e.jsx("span",{className:"px-2 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-medium",children:s})}},v=p.filter(s=>s.status==="pending").length;return k?e.jsx(_,{children:e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})})}):e.jsx(_,{children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:"Règlements"}),e.jsx("p",{className:"text-slate-600",children:"Gestion des règlements des livreurs"})]}),v>0&&i!=="pending"&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M,{className:"w-5 h-5 text-amber-600"}),e.jsxs("p",{className:"text-amber-800",children:[e.jsx("strong",{children:v})," règlement(s) en attente de confirmation"]}),e.jsx("button",{onClick:()=>g("pending"),className:"ml-auto text-amber-700 hover:text-amber-800 font-medium",children:"Voir →"})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(T,{className:"w-5 h-5 text-slate-400"}),e.jsxs("select",{value:i,onChange:s=>g(s.target.value),className:"px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"pending",children:"En attente"}),e.jsx("option",{value:"confirmed",children:"Confirmé"}),e.jsx("option",{value:"disputed",children:"Contesté"})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-slate-50 border-b border-slate-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-6 py-4 text-sm font-semibold text-slate-900",children:"Livreur"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-semibold text-slate-900",children:"Période"}),e.jsx("th",{className:"text-center px-6 py-4 text-sm font-semibold text-slate-900",children:"Échanges"}),e.jsx("th",{className:"text-right px-6 py-4 text-sm font-semibold text-slate-900",children:"Montant"}),e.jsx("th",{className:"text-center px-6 py-4 text-sm font-semibold text-slate-900",children:"Statut"}),e.jsx("th",{className:"text-right px-6 py-4 text-sm font-semibold text-slate-900",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:p.map(s=>{var a,d;return e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center",children:e.jsx(z,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:((a=s.delivery_person)==null?void 0:a.name)||"Livreur"}),e.jsx("p",{className:"text-sm text-slate-500",children:((d=s.delivery_person)==null?void 0:d.email)||"—"})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600",children:[e.jsx(B,{className:"w-4 h-4"}),new Date(s.period_start).toLocaleDateString("fr-FR")," -"," ",new Date(s.period_end).toLocaleDateString("fr-FR")]})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"font-medium text-slate-900",children:s.exchanges_count})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("p",{className:"font-semibold text-slate-900",children:[s.amount.toFixed(2)," TND"]})}),e.jsx("td",{className:"px-6 py-4 text-center",children:q(s.status)}),e.jsxs("td",{className:"px-6 py-4",children:[s.status==="pending"&&e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>{l(s),u(!0)},className:"px-3 py-1.5 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700 transition-colors",children:"Confirmer"}),e.jsx("button",{onClick:()=>{l(s),h(!0)},className:"px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded-lg hover:bg-red-50 transition-colors",children:"Contester"})]}),s.status==="confirmed"&&s.confirmed_at&&e.jsxs("p",{className:"text-xs text-slate-500 text-right",children:["Confirmé le"," ",new Date(s.confirmed_at).toLocaleDateString("fr-FR")]})]})]},s.id)})})]})}),p.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"w-12 h-12 text-slate-300 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500",children:"Aucun règlement trouvé"})]})]}),E&&t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 bg-emerald-100 rounded-lg",children:e.jsx(C,{className:"w-6 h-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:"Confirmer le Règlement"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Valider la réception du montant"})]})]}),e.jsx("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Livreur"}),e.jsx("span",{className:"font-medium text-slate-900",children:(y=t.delivery_person)==null?void 0:y.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Montant"}),e.jsxs("span",{className:"font-semibold text-emerald-600",children:[t.amount.toFixed(2)," TND"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Échanges"}),e.jsx("span",{className:"font-medium text-slate-900",children:t.exchanges_count})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Notes (optionnel)"}),e.jsx("input",{type:"text",value:N,onChange:s=>f(s.target.value),placeholder:"Ex: Reçu en espèces...",className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{u(!1),l(null),f("")},disabled:n,className:"flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:F,disabled:n,className:"flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:n?"Traitement...":"Confirmer"})]})]})})}),A&&t&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-3 bg-red-100 rounded-lg",children:e.jsx(S,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:"Contester le Règlement"}),e.jsx("p",{className:"text-sm text-slate-600",children:"Indiquez la raison de la contestation"})]})]}),e.jsx("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Livreur"}),e.jsx("span",{className:"font-medium text-slate-900",children:(w=t.delivery_person)==null?void 0:w.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Montant"}),e.jsxs("span",{className:"font-semibold text-slate-900",children:[t.amount.toFixed(2)," TND"]})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Raison de la contestation *"}),e.jsx("textarea",{value:c,onChange:s=>j(s.target.value),placeholder:"Expliquez pourquoi ce règlement est contesté...",rows:3,className:"w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{h(!1),l(null),j("")},disabled:n,className:"flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors",children:"Annuler"}),e.jsx("button",{onClick:L,disabled:n||!c.trim(),className:"flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 disabled:bg-slate-300 text-white rounded-lg font-medium transition-colors",children:n?"Traitement...":"Contester"})]})]})})})]})})}export{ce as default};
