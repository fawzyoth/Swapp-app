import{u as X,s as o,j as e}from"./index-D04Gu7ka.js";import{h as G,u as J,r as l}from"./react-vendor-CTUriZ5h.js";import{L as K}from"./LanguageSwitcher-BptKYsfA.js";import{A as N}from"./alert-circle-_Iqic_ih.js";import{A as W}from"./arrow-left-CxjwE-xR.js";import{C as Y}from"./calendar-upMk3ayk.js";import{M as Z}from"./map-pin-DUtVdt2Q.js";import{P as V}from"./phone-BNQXnIac.js";import{T as v}from"./truck-CgEV9F53.js";import{V as ee}from"./video-Cwp6uQ4V.js";import{M as L}from"./message-square-B53yKzw3.js";import{S as se}from"./send-DlqxrGT5.js";import{C as M}from"./clock-Dhxn45-3.js";import{C as w}from"./check-circle-CyNeZd0p.js";import{P}from"./package-ChDCFdB3.js";import{C as te}from"./check-Cm21nyZb.js";import{X as ae}from"./x-D4qrk5Qy.js";import"./supabase-Bl4YWSQ9.js";import"./createLucideIcon-CMjKDoEE.js";function ye(){const{code:y}=G(),C=J(),{t:d,lang:t,dir:u}=X(),[a,T]=l.useState(null),[g,R]=l.useState([]),[p,S]=l.useState([]),[h,_]=l.useState(""),[k,D]=l.useState(!1),[n,$]=l.useState(null),[c,q]=l.useState(null),[A,I]=l.useState(!0),E=l.useRef(null),F={pending:{fr:"En attente",ar:"قيد الانتظار"},validated:{fr:"Validé",ar:"تمت الموافقة"},preparing:{fr:"En préparation",ar:"قيد التحضير"},in_transit:{fr:"En transit",ar:"في الطريق"},completed:{fr:"Terminé",ar:"مكتمل"},returned:{fr:"Retourné",ar:"مُرجع"},rejected:{fr:"Rejeté",ar:"مرفوض"}},O=s=>{var r;return((r=F[s])==null?void 0:r[t])||s};l.useEffect(()=>{B()},[y]);const B=async()=>{try{const{data:s}=await o.from("exchanges").select("*").eq("exchange_code",y).maybeSingle();if(s){T(s);const{data:r}=await o.from("status_history").select("*").eq("exchange_id",s.id).order("created_at",{ascending:!1});R(r||[]);const{data:i}=await o.from("messages").select("*").eq("exchange_id",s.id).order("created_at",{ascending:!0});if(S(i||[]),s.mini_depot_id){const{data:x}=await o.from("mini_depots").select("*").eq("id",s.mini_depot_id).maybeSingle();$(x)}if(s.transporter_id){const{data:x}=await o.from("transporters").select("*").eq("id",s.transporter_id).maybeSingle();q(x)}}}catch(s){console.error("Error fetching exchange:",s)}finally{I(!1)}},H=()=>{var s;(s=E.current)==null||s.scrollIntoView({behavior:"smooth"})};l.useEffect(()=>{H()},[p]);const z=async s=>{if(s.preventDefault(),!(!h.trim()||!a)){D(!0);try{await o.from("messages").insert({exchange_id:a.id,sender_type:"client",message:h.trim()}),_("");const{data:r}=await o.from("messages").select("*").eq("exchange_id",a.id).order("created_at",{ascending:!0});S(r||[])}catch(r){console.error("Error sending message:",r)}finally{D(!1)}}},Q=()=>{const s=[{key:"pending",label:t==="ar"?"تم الإرسال":"Demande soumise",icon:M},{key:"validated",label:t==="ar"?"تمت الموافقة":"Validée",icon:w},{key:"preparing",label:t==="ar"?"قيد التحضير":"En préparation",icon:P},{key:"in_transit",label:t==="ar"?"في الطريق":"En transit",icon:v},{key:"completed",label:t==="ar"?"تم التوصيل":"Livrée",icon:te}],i=["pending","validated","preparing","in_transit","completed"].indexOf(a==null?void 0:a.status);return s.map((x,f)=>({...x,isCompleted:f<=i&&(a==null?void 0:a.status)!=="rejected",isCurrent:f===i&&(a==null?void 0:a.status)!=="rejected",isRejected:(a==null?void 0:a.status)==="rejected"&&f>0}))},b=s=>{switch(s){case"pending":return{color:"bg-amber-50 border-amber-200",textColor:"text-amber-700",icon:M,message:t==="ar"?"طلبك قيد المراجعة من قبل التاجر":"Votre demande est en cours d'examen par le marchand",action:t==="ar"?"في انتظار الموافقة":"En attente de validation"};case"validated":return{color:"bg-blue-50 border-blue-200",textColor:"text-blue-700",icon:w,message:t==="ar"?"تمت الموافقة على التبديل":"Votre échange a été approuvé",action:t==="ar"?"قيد التحضير":"Préparation en cours"};case"preparing":return{color:"bg-purple-50 border-purple-200",textColor:"text-purple-700",icon:P,message:t==="ar"?"منتجك الجديد قيد التحضير":"Votre nouveau produit est en cours de préparation",action:t==="ar"?"سيتم الشحن قريباً":"Sera bientôt expédié"};case"in_transit":return{color:"bg-indigo-50 border-indigo-200",textColor:"text-indigo-700",icon:v,message:t==="ar"?"طردك في الطريق":"Votre colis est en route",action:t==="ar"?"جاري التوصيل":"Livraison en cours"};case"completed":return{color:"bg-emerald-50 border-emerald-200",textColor:"text-emerald-700",icon:w,message:t==="ar"?"تم التبديل بنجاح":"Votre échange est terminé",action:t==="ar"?"اكتمل التبديل":"Échange complété"};case"rejected":return{color:"bg-red-50 border-red-200",textColor:"text-red-700",icon:ae,message:t==="ar"?"تم رفض طلبك":"Votre demande a été refusée",action:t==="ar"?"تم الرفض":"Échange refusé"};default:return{color:"bg-slate-50 border-slate-200",textColor:"text-slate-700",icon:N,message:"",action:""}}};if(A)return e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"})});if(!a)return e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center",dir:u,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(N,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-900 mb-2",children:d("exchangeNotFound")}),e.jsx("p",{className:"text-slate-600 mb-6",children:d("checkCodeAndRetry")}),e.jsx("button",{onClick:()=>C("/client/scan"),className:"px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium",children:d("scanQRCode")})]})});const m=b(a.status),U=m.icon,j=Q();return e.jsx("div",{className:"min-h-screen bg-slate-50",dir:u,children:e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-5xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("button",{onClick:()=>C("/client/scan"),className:"flex items-center text-slate-600 hover:text-slate-900 transition-colors",children:[e.jsx(W,{className:"w-5 h-5 me-2"}),e.jsx("span",{className:"font-medium",children:d("back")})]}),e.jsx(K,{})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:`rounded-2xl border-2 p-6 ${m.color}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-3 rounded-xl bg-white shadow-sm",children:e.jsx(U,{className:`w-8 h-8 ${m.textColor}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-2",children:m.action}),e.jsx("p",{className:"text-slate-700 text-lg mb-4",children:m.message}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsxs("span",{children:[t==="ar"?"تاريخ الطلب: ":"Demande créée le ",new Date(a.created_at).toLocaleDateString(t==="ar"?"ar-TN":"fr-FR",{year:"numeric",month:"long",day:"numeric"})]})]})]})]})}),a.status!=="rejected"&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 mb-6",children:t==="ar"?"تقدم التبديل":"Progression de votre échange"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-5 left-0 right-0 h-1 bg-slate-200",children:e.jsx("div",{className:"h-full bg-emerald-500 transition-all duration-500",style:{width:`${j.filter(s=>s.isCompleted).length/j.length*100}%`}})}),e.jsx("div",{className:"relative flex justify-between",children:j.map((s,r)=>{const i=s.icon;return e.jsxs("div",{className:"flex flex-col items-center flex-1",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${s.isCompleted?"bg-emerald-500 border-emerald-500":s.isCurrent?"bg-white border-emerald-500":"bg-white border-slate-300"}`,children:e.jsx(i,{className:`w-5 h-5 ${s.isCompleted?"text-white":s.isCurrent?"text-emerald-500":"text-slate-400"}`})}),e.jsx("div",{className:"mt-3 text-center",children:e.jsx("div",{className:`text-sm font-medium ${s.isCompleted||s.isCurrent?"text-slate-900":"text-slate-500"}`,children:s.label})})]},s.key)})})]})]}),a.status==="rejected"&&a.rejection_reason&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-2xl p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(N,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900 mb-1",children:t==="ar"?"سبب الرفض":"Motif du refus"}),e.jsx("p",{className:"text-red-700",children:a.rejection_reason})]})]})}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 mb-4",children:t==="ar"?"تفاصيل الطلب":"Détails de la demande"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500 mb-1",children:d("exchangeCode")}),e.jsx("div",{className:"font-mono font-semibold text-slate-900 text-lg",children:a.exchange_code})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500 mb-1",children:d("fullName")}),e.jsx("div",{className:"font-medium text-slate-900",children:a.client_name})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500 mb-1",children:d("phone")}),e.jsx("div",{className:"font-medium text-slate-900",dir:"ltr",children:a.client_phone})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500 mb-1",children:d("reason")}),e.jsx("div",{className:"font-medium text-slate-900",children:a.reason})]})]})]}),(n||c)&&e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[n&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Z,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:t==="ar"?"نقطة الاستلام":"Point de retrait"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:t==="ar"?"الاسم":"Nom"}),e.jsx("div",{className:"font-medium text-slate-900",children:n.name})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:d("address")}),e.jsx("div",{className:"font-medium text-slate-900",children:n.address}),e.jsx("div",{className:"text-slate-700",children:n.city})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:d("phone")}),e.jsxs("a",{href:`tel:${n.phone}`,className:"font-medium text-emerald-600 hover:text-emerald-700 flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"}),n.phone]})]})]})]}),c&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(v,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:t==="ar"?"شركة النقل":"Transporteur"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:t==="ar"?"الشركة":"Société"}),e.jsx("div",{className:"font-medium text-slate-900",children:c.name})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:t==="ar"?"التواصل":"Contact"}),e.jsxs("a",{href:`tel:${c.phone}`,className:"font-medium text-emerald-600 hover:text-emerald-700 flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"}),c.phone]})]})]})]})]}),g.length>0&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 mb-4",children:t==="ar"?"السجل":"Historique"}),e.jsx("div",{className:"space-y-4",children:g.map((s,r)=>{const i=b(s.status).icon;return e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`p-2 rounded-lg ${b(s.status).color}`,children:e.jsx(i,{className:"w-4 h-4"})}),r<g.length-1&&e.jsx("div",{className:"w-0.5 flex-1 bg-slate-200 min-h-[24px] my-1"})]}),e.jsxs("div",{className:"flex-1 pb-2",children:[e.jsx("p",{className:"font-medium text-slate-900",children:O(s.status)}),e.jsx("p",{className:"text-sm text-slate-600",children:new Date(s.created_at).toLocaleDateString(t==="ar"?"ar-TN":"fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]},s.id)})})]}),a.video&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ee,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:t==="ar"?"فيديو المنتج":"Vidéo du produit"})]}),e.jsx("video",{src:a.video,controls:!0,className:"w-full max-h-64 rounded-xl border border-slate-200 bg-black"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(L,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:t==="ar"?"المراسلات":"Messages"})]}),e.jsxs("div",{className:"space-y-3 max-h-80 overflow-y-auto mb-4",children:[p.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(L,{className:"w-12 h-12 mx-auto mb-3 text-slate-300"}),e.jsx("p",{children:t==="ar"?"لا توجد رسائل بعد":"Aucun message pour le moment"}),e.jsx("p",{className:"text-sm mt-1",children:t==="ar"?"أرسل رسالة للتاجر لأي استفسار":"Envoyez un message au marchand pour toute question"})]}):p.map(s=>e.jsxs("div",{className:`p-3 rounded-xl max-w-[85%] ${s.sender_type==="client"?"bg-emerald-50 border border-emerald-200 ms-auto":"bg-slate-100 border border-slate-200 me-auto"}`,children:[e.jsx("p",{className:"text-xs font-medium text-slate-500 mb-1",children:s.sender_type==="client"?t==="ar"?"أنت":"Vous":t==="ar"?"التاجر":"Marchand"}),e.jsx("p",{className:"text-slate-800",children:s.message}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:new Date(s.created_at).toLocaleString(t==="ar"?"ar-TN":"fr-FR",{hour:"2-digit",minute:"2-digit",day:"numeric",month:"short"})})]},s.id)),e.jsx("div",{ref:E})]}),e.jsxs("form",{onSubmit:z,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:h,onChange:s=>_(s.target.value),placeholder:t==="ar"?"اكتب رسالتك...":"Votre message...",className:"flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",dir:u}),e.jsx("button",{type:"submit",disabled:k||!h.trim(),className:"px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:k?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(se,{className:"w-5 h-5"})})]})]}),a.photos&&a.photos.length>0&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-200 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 mb-4",children:t==="ar"?"صور المنتج":"Photos du produit"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:a.photos.map((s,r)=>e.jsx("img",{src:s,alt:`Photo ${r+1}`,className:"w-full h-48 object-cover rounded-xl border border-slate-200"},r))})]})]})]})})}export{ye as default};
